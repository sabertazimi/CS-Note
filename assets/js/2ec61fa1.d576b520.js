"use strict";(self.webpackChunkawesome_notes=self.webpackChunkawesome_notes||[]).push([[4724],{2565:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"Web/Vue/VueAdvancedNotes","title":"Vue Advanced Notes","description":"Vue Constructor","source":"@site/notes/Web/Vue/VueAdvancedNotes.md","sourceDirName":"Web/Vue","slug":"/Web/Vue/VueAdvancedNotes","permalink":"/awesome-notes/Web/Vue/VueAdvancedNotes","draft":false,"unlisted":false,"editUrl":"https://github.com/sabertazimi/awesome-notes/edit/main/notes/Web/Vue/VueAdvancedNotes.md","tags":[{"inline":true,"label":"Web","permalink":"/awesome-notes/tags/web"},{"inline":true,"label":"Vue","permalink":"/awesome-notes/tags/vue"}],"version":"current","lastUpdatedBy":"renovate[bot]","lastUpdatedAt":1732127335000,"frontMatter":{"author":"Sabertazimi","authorTitle":"Web Developer","authorURL":"https://github.com/sabertazimi","authorImageURL":"https://github.com/sabertazimi.png","tags":["Web","Vue"]},"sidebar":"tutorialSidebar","previous":{"title":"Security Basic Notes","permalink":"/awesome-notes/Web/Security/SecurityBasicNotes"},"next":{"title":"Vue Basic Notes","permalink":"/awesome-notes/Web/Vue/VueBasicNotes"}}');var i=t(5105),r=t(842);const o={author:"Sabertazimi",authorTitle:"Web Developer",authorURL:"https://github.com/sabertazimi",authorImageURL:"https://github.com/sabertazimi.png",tags:["Web","Vue"]},c="Vue Advanced Notes",l={},a=[{value:"Vue Constructor",id:"vue-constructor",level:2},{value:"Vue Prototype",id:"vue-prototype",level:2},{value:"Vue Global API",id:"vue-global-api",level:2},{value:"Vue Global Extend API",id:"vue-global-extend-api",level:3},{value:"Vue Global NextTick API",id:"vue-global-nexttick-api",level:3},{value:"Vue Global Mixin API",id:"vue-global-mixin-api",level:3},{value:"Vue Global Use API",id:"vue-global-use-api",level:3},{value:"Vue Options API",id:"vue-options-api",level:2},{value:"Vue Merge Options",id:"vue-merge-options",level:3},{value:"Vue Normalize Options",id:"vue-normalize-options",level:3},{value:"Vue Mounting Workflow",id:"vue-mounting-workflow",level:2},{value:"Vue Lifecycle",id:"vue-lifecycle",level:2},{value:"Vue Options Lifecycle",id:"vue-options-lifecycle",level:3},{value:"Vue Composition Lifecycle",id:"vue-composition-lifecycle",level:3},{value:"Vue Instance",id:"vue-instance",level:2},{value:"Vue Virtual DOM",id:"vue-virtual-dom",level:2},{value:"Vue Template and Compiler",id:"vue-template-and-compiler",level:2},{value:"Vue Compilation Workflow",id:"vue-compilation-workflow",level:3},{value:"Vue Compilation Performance",id:"vue-compilation-performance",level:3},{value:"Vue Two-Way Data Binding",id:"vue-two-way-data-binding",level:2},{value:"Vue Legacy Reactivity",id:"vue-legacy-reactivity",level:2},{value:"Vue Watcher and Observer",id:"vue-watcher-and-observer",level:3},{value:"Vue Array Watcher",id:"vue-array-watcher",level:3},{value:"Vue Global Set and Delete API",id:"vue-global-set-and-delete-api",level:3},{value:"Vue Computed Watcher",id:"vue-computed-watcher",level:3},{value:"Vue Router Watcher",id:"vue-router-watcher",level:3},{value:"Vue Modern Reactivity",id:"vue-modern-reactivity",level:2},{value:"Reactive System",id:"reactive-system",level:3},{value:"Reactive Effects",id:"reactive-effects",level:3},{value:"Reactive Proxy",id:"reactive-proxy",level:3},{value:"Vue Setup",id:"vue-setup",level:2},{value:"Vue Reference",id:"vue-reference",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"vue-advanced-notes",children:"Vue Advanced Notes"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-constructor",children:"Vue Constructor"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/index.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// \u4ece\u4e94\u4e2a\u6587\u4ef6\u5bfc\u5165\u4e94\u4e2a\u65b9\u6cd5\uff08\u4e0d\u5305\u62ec warn\uff09\nimport { warn } from '../util/index'\nimport { eventsMixin } from './events'\nimport { initMixin } from './init'\nimport { lifecycleMixin } from './lifecycle'\nimport { renderMixin } from './render'\nimport { stateMixin } from './state'\n\n// \u5b9a\u4e49 Vue \u6784\u9020\u51fd\u6570\nfunction Vue(options) {\n  this._init(options)\n}\n\n// \u5c06 Vue \u4f5c\u4e3a\u53c2\u6570\u4f20\u9012\u7ed9\u5bfc\u5165\u7684\u4e94\u4e2a\u65b9\u6cd5\ninitMixin(Vue)\nstateMixin(Vue)\neventsMixin(Vue)\nlifecycleMixin(Vue)\nrenderMixin(Vue)\n\n// \u5bfc\u51fa Vue\nexport default Vue\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/init.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// initMixin(Vue)\nVue.prototype._init = function (options?: object) {}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/state.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// stateMixin(Vue)\nVue.prototype.$data = data\nVue.prototype.$props = props\nVue.prototype.$set = set\nVue.prototype.$delete = del\nVue.prototype.$watch = function (\n  expOrFn: string | Function,\n  cb: any,\n  options?: object\n): Function {}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/events.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// eventsMixin(Vue)\nVue.prototype.$on = function (\n  event: string | Array<string>,\n  fn: Function\n): Component {}\nVue.prototype.$once = function (event: string, fn: Function): Component {}\nVue.prototype.$off = function (\n  event?: string | Array<string>,\n  fn?: Function\n): Component {}\nVue.prototype.$emit = function (event: string): Component {}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// lifecycleMixin(Vue)\nVue.prototype._update = function (vnode: VNode, hydrating?: boolean) {}\nVue.prototype.$forceUpdate = function () {}\nVue.prototype.$destroy = function () {}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/render.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function initRender(vm: Component) {\n  vm._vnode = null // the root of the child tree\n  vm._staticTrees = null // v-once cached trees\n  const options = vm.$options\n  const parentVnode = (vm.$vnode = options._parentVnode)\n  const renderContext = parentVnode && parentVnode.context\n  vm.$slots = resolveSlots(options._renderChildren, renderContext)\n  vm.$scopedSlots = emptyObject\n  vm._c = (a, b, c, d) => createElement(vm, a, b, c, d, false)\n  vm.$createElement = (a, b, c, d) => createElement(vm, a, b, c, d, true)\n  const parentData = parentVnode && parentVnode.data\n}\n\nexport function renderMixin(Vue: Class<Component>) {\n  installRenderHelpers(Vue.prototype)\n  Vue.prototype.$nextTick = function (fn: Function) {\n    return nextTick(fn, this)\n  }\n  Vue.prototype._render = function (): VNode {}\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/render-helpers/index.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function installRenderHelpers(target: any) {\n  target._o = markOnce\n  target._n = toNumber\n  target._s = toString\n  target._l = renderList\n  target._t = renderSlot\n  target._q = looseEqual\n  target._i = looseIndexOf\n  target._m = renderStatic\n  target._f = resolveFilter\n  target._k = checkKeyCodes\n  target._b = bindObjectProps\n  target._v = createTextVNode\n  target._e = createEmptyVNode\n  target._u = resolveScopedSlots\n  target._g = bindObjectListeners\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-prototype",children:"Vue Prototype"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/index.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { isServerRendering } from 'core/util/env'\nimport { FunctionalRenderContext } from 'core/vdom/create-functional-component'\nimport { initGlobalAPI } from './global-api/index'\nimport Vue from './instance/index'\n\ninitGlobalAPI(Vue)\n\nObject.defineProperty(Vue.prototype, '$isServer', {\n  get: isServerRendering,\n})\n\nObject.defineProperty(Vue.prototype, '$ssrContext', {\n  get() {\n    return this.$vnode && this.$vnode.ssrContext\n  },\n})\n\n// expose FunctionalRenderContext for ssr runtime helper installation\nObject.defineProperty(Vue, 'FunctionalRenderContext', {\n  value: FunctionalRenderContext,\n})\n\nVue.version = '__VERSION__'\n\nexport default Vue\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"runtime/index.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import config from 'core/config'\nimport Vue from 'core/index'\nimport { mountComponent } from 'core/instance/lifecycle'\nimport { devtools, inBrowser, isChrome } from 'core/util/index'\nimport { extend, noop } from 'shared/util'\n\nimport {\n  getTagNamespace,\n  isReservedAttr,\n  isReservedTag,\n  isUnknownElement,\n  mustUseProp,\n  query,\n} from 'web/util/index'\n\nimport platformComponents from './components/index'\nimport platformDirectives from './directives/index'\nimport { patch } from './patch'\n\n// Install platform specific utils.\nVue.config.mustUseProp = mustUseProp\nVue.config.isReservedTag = isReservedTag\nVue.config.isReservedAttr = isReservedAttr\nVue.config.getTagNamespace = getTagNamespace\nVue.config.isUnknownElement = isUnknownElement\n\n// Install platform runtime directives & components.\nextend(Vue.options.directives, platformDirectives)\nextend(Vue.options.components, platformComponents)\n\n// Install platform patch function.\nVue.prototype.__patch__ = inBrowser ? patch : noop\n\n// Public mount method.\nVue.prototype.$mount = function (\n  el?: string | Element,\n  hydrating?: boolean\n): Component {\n  el = el && inBrowser ? query(el) : undefined\n  return mountComponent(this, el, hydrating)\n}\n\nexport default Vue\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"platforms/web/entry-runtime-with-compiler.js"})," \u91cd\u5199 ",(0,i.jsx)(n.code,{children:"Vue.prototype.$mount"})," \u65b9\u6cd5:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import config from 'core/config'\nimport { cached } from 'core/util/index'\n\nimport { compileToFunctions } from './compiler/index'\nimport Vue from './runtime/index'\nimport {\n  shouldDecodeNewlines,\n  shouldDecodeNewlinesForHref,\n} from './util/compat'\nimport { query } from './util/index'\n\nconst mount = Vue.prototype.$mount\n\nconst idToTemplate = cached((id) => {\n  const el = query(id)\n  return el && el.innerHTML\n})\n\n/**\n * Get outerHTML of elements, taking care\n * of SVG elements in IE as well.\n */\nfunction getOuterHTML(el: Element): string {\n  if (el.outerHTML) {\n    return el.outerHTML\n  } else {\n    const container = document.createElement('div')\n    container.appendChild(el.cloneNode(true))\n    return container.innerHTML\n  }\n}\n\nVue.prototype.$mount = function (\n  el?: string | Element,\n  hydrating?: boolean\n): Component {\n  el = el && query(el)\n\n  if (el === document.body || el === document.documentElement) {\n    // Do not mount Vue to <html> or <body>\n    return this\n  }\n\n  const options = this.$options\n  // resolve template/el and convert to render function\n  if (!options.render) {\n    let template = options.template\n    if (template) {\n      if (typeof template === 'string') {\n        if (template.charAt(0) === '#')\n          template = idToTemplate(template)\n      } else if (template.nodeType) {\n        template = template.innerHTML\n      } else {\n        // Invalid template option\n        return this\n      }\n    } else if (el) {\n      template = getOuterHTML(el)\n    }\n    if (template) {\n      const { render, staticRenderFns } = compileToFunctions(\n        template,\n        {\n          shouldDecodeNewlines,\n          shouldDecodeNewlinesForHref,\n          delimiters: options.delimiters,\n          comments: options.comments,\n        },\n        this\n      )\n      options.render = render\n      options.staticRenderFns = staticRenderFns\n    }\n  }\n\n  return mount.call(this, el, hydrating)\n}\n\nVue.compile = compileToFunctions\n\nexport default Vue\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-global-api",children:"Vue Global API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/global-api/index.js"})," \u6dfb\u52a0 ",(0,i.jsx)(n.code,{children:"Vue.XXX"})," \u9759\u6001\u65b9\u6cd5:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// initGlobalAPI\nVue.config = config\nVue.util = {\n  warn,\n  extend,\n  mergeOptions,\n  defineReactive,\n}\nVue.set = set\nVue.delete = del\nVue.nextTick = nextTick\nVue.options = {\n  components: {\n    KeepAlive,\n    // Transition \u548c TransitionGroup \u7ec4\u4ef6\u5728 runtime/index.js \u6587\u4ef6\u4e2d\u88ab\u6dfb\u52a0\n    // Transition,\n    // TransitionGroup\n  },\n  directives: Object.create(null),\n  // \u5728 runtime/index.js \u6587\u4ef6\u4e2d, \u4e3a directives \u6dfb\u52a0\u4e86\u4e24\u4e2a\u5e73\u53f0\u5316\u7684\u6307\u4ee4 model \u548c show\n  // directives:{\n  // model,\n  // show\n  // },\n  filters: Object.create(null),\n  _base: Vue,\n}\n\n// initUse: global-api/use.js\nVue.use = function (plugin: Function | object) {}\n\n// initMixin: global-api/mixin.js\nVue.mixin = function (mixin: object) {}\n\n// initExtend: global-api/extend.js\nVue.cid = 0\nVue.extend = function (extendOptions: object): Function {}\n\n// initAssetRegisters: global-api/assets.js\nVue.component\n  = Vue.directive\n  = Vue.filter\n    = function (\n        id: string,\n        definition: Function | object\n      ): Function | object | void {}\n\n// expose FunctionalRenderContext for ssr runtime helper installation\nObject.defineProperty(Vue, 'FunctionalRenderContext', {\n  value: FunctionalRenderContext,\n})\n\nVue.version = '__VERSION__'\n\n// entry-runtime-with-compiler.js\nVue.compile = compileToFunctions\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-global-extend-api",children:"Vue Global Extend API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/global-api/extend.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.extend"}),"/",(0,i.jsx)(n.code,{children:"vm.$options._base.extend"})," will return brand new ",(0,i.jsx)(n.code,{children:"Vue"})," constructor."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/**\n * Class inheritance\n */\nVue.extend = function (extendOptions: object): Function {\n  extendOptions = extendOptions || {}\n  // eslint-disable-next-line ts/no-this-alias\n  const Super = this\n  const SuperId = Super.cid\n  const cachedCtors = extendOptions._Ctor || (extendOptions._Ctor = {})\n\n  if (cachedCtors[SuperId])\n    return cachedCtors[SuperId]\n\n  const name = extendOptions.name || Super.options.name\n  const Sub = function VueComponent(options) {\n    this._init(options)\n  }\n\n  Sub.prototype = Object.create(Super.prototype)\n  Sub.prototype.constructor = Sub\n  Sub.cid = cid++\n  Sub.options = mergeOptions(Super.options, extendOptions)\n  Sub.super = Super\n\n  // For props and computed properties, we define the proxy getters on\n  // the Vue instances at extension time, on the extended prototype. This\n  // avoids Object.defineProperty calls for each instance created.\n  if (Sub.options.props)\n    initProps(Sub)\n\n  if (Sub.options.computed)\n    initComputed(Sub)\n\n  // allow further extension/mixin/plugin usage\n  Sub.extend = Super.extend\n  Sub.mixin = Super.mixin\n  Sub.use = Super.use\n\n  // create asset registers, so extended classes\n  // can have their private assets too.\n  ASSET_TYPES.forEach((type) => {\n    Sub[type] = Super[type]\n  })\n\n  // enable recursive self-lookup\n  if (name)\n    Sub.options.components[name] = Sub\n\n  // keep a reference to the super options at extension time.\n  // later at instantiation we can check if Super's options have\n  // been updated.\n  Sub.superOptions = Super.options\n  Sub.extendOptions = extendOptions\n  Sub.sealedOptions = extend({}, Sub.options)\n\n  // cache constructor\n  cachedCtors[SuperId] = Sub\n  return Sub\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-global-nexttick-api",children:"Vue Global NextTick API"}),"\n",(0,i.jsxs)(n.p,{children:["\u4e3a\u4e86\u51cf\u5c11\u5e03\u5c40\u548c\u6e32\u67d3,\n",(0,i.jsx)(n.code,{children:"Vue"})," \u628a ",(0,i.jsx)(n.code,{children:"DOM"})," \u66f4\u65b0\u8bbe\u8ba1\u4e3a\u5f02\u6b65\u66f4\u65b0,\n\u6bcf\u6b21\u4fa6\u542c\u5230\u6570\u636e\u53d8\u5316,\n\u5c06\u5f00\u542f\u4e00\u4e2a\u961f\u5217,\n\u5e76\u7f13\u51b2\u5728\u540c\u4e00\u4e8b\u4ef6\u5faa\u73af\u4e2d\u53d1\u751f\u7684\u6240\u6709\u6570\u636e\u53d8\u66f4.\n\u5982\u679c\u540c\u4e00\u4e2a ",(0,i.jsx)(n.code,{children:"watcher"})," \u88ab\u591a\u6b21\u89e6\u53d1,\n\u53ea\u4f1a\u88ab\u63a8\u5165\u5230\u961f\u5217\u4e2d\u4e00\u6b21.\n\u5728\u4e0b\u4e00\u4e2a\u4e8b\u4ef6\u5faa\u73af tick \u4e2d,\n",(0,i.jsx)(n.code,{children:"Vue"})," \u624d\u4f1a\u771f\u6b63\u6267\u884c\u961f\u5217\u4e2d\u7684\u6570\u636e\u53d8\u66f4,\n\u9875\u9762\u624d\u4f1a\u91cd\u65b0\u6e32\u67d3,\n\u4f7f\u5f97\u591a\u6b21 DOM \u66f4\u65b0\u5408\u5e76\u6210\u4e00\u6b21\u6279\u5904\u7406\u66f4\u65b0."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/util/next-tick.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import { noop } from 'shared/util'\nimport { isIOS, isNative } from './env'\nimport { handleError } from './error'\n\nconst callbacks = []\nlet pending = false\n\nfunction flushCallbacks() {\n  pending = false\n  const copies = callbacks.slice(0)\n  callbacks.length = 0\n\n  for (let i = 0; i < copies.length; i++) copies[i]()\n}\n\nlet microTimerFunc\nlet macroTimerFunc\nlet useMacroTask = false\n\n// setImmediate -> MessageChannel -> setTimeout.\nif (typeof setImmediate !== 'undefined' && isNative(setImmediate)) {\n  macroTimerFunc = () => {\n    setImmediate(flushCallbacks)\n  }\n} else if (\n  typeof MessageChannel !== 'undefined'\n  && (isNative(MessageChannel)\n  // PhantomJS\n    || MessageChannel.toString() === '[object MessageChannelConstructor]')\n) {\n  const channel = new MessageChannel()\n  const port = channel.port2\n  channel.port1.onmessage = flushCallbacks\n  macroTimerFunc = () => {\n    port.postMessage(1)\n  }\n} else {\n  macroTimerFunc = () => {\n    setTimeout(flushCallbacks, 0)\n  }\n}\n\n// Promise.then -> Macro Timer.\nif (typeof Promise !== 'undefined' && isNative(Promise)) {\n  const p = Promise.resolve()\n  microTimerFunc = () => {\n    p.then(flushCallbacks)\n    if (isIOS)\n      setTimeout(noop)\n  }\n} else {\n  microTimerFunc = macroTimerFunc\n}\n\n/**\n * Wrap a function so that if any code inside triggers state change,\n * the changes are queued using a (macro) task instead of a micro task.\n */\nexport function withMacroTask(fn: Function): Function {\n  return (\n    fn._withTask\n    || (fn._withTask = function (...args) {\n      useMacroTask = true\n      const res = fn(...args)\n      useMacroTask = false\n      return res\n    })\n  )\n}\n\nexport function nextTick(cb?: Function, ctx?: object) {\n  let _resolve\n\n  callbacks.push(() => {\n    if (cb) {\n      try {\n        cb.call(ctx)\n      } catch (e) {\n        handleError(e, ctx, 'nextTick')\n      }\n    } else if (_resolve) {\n      _resolve(ctx)\n    }\n  })\n\n  if (!pending) {\n    pending = true\n\n    if (useMacroTask)\n      macroTimerFunc()\n    else microTimerFunc()\n  }\n\n  if (!cb && typeof Promise !== 'undefined') {\n    return new Promise((resolve) => {\n      _resolve = resolve\n    })\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-global-mixin-api",children:"Vue Global Mixin API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/global-api/mixin.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function initMixin(Vue: GlobalAPI) {\n  Vue.mixin = function (mixin: object) {\n    this.options = mergeOptions(this.options, mixin)\n    return this\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-global-use-api",children:"Vue Global Use API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/global-api/use.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function initUse(Vue: GlobalAPI) {\n  Vue.use = function (plugin: Function | object, ...args: any) {\n    const installedPlugins\n      = this._installedPlugins || (this._installedPlugins = [])\n\n    if (installedPlugins.includes(plugin))\n      return this\n\n    // Pass `Vue` to plugin install hook.\n    args.unshift(this)\n\n    if (typeof plugin.install === 'function')\n      plugin.install(...args)\n    else if (typeof plugin === 'function')\n      plugin(...args)\n\n    installedPlugins.push(plugin)\n    return this\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-options-api",children:"Vue Options API"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/init.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"vm.$options = mergeOptions(\n  // resolveConstructorOptions(vm.constructor)\n  {\n    components: {\n      KeepAlive,\n      Transition,\n      TransitionGroup,\n    },\n    directives: {\n      model,\n      show,\n    },\n    filters: Object.create(null),\n    _base: Vue,\n  },\n  // options || {}\n  {\n    el: '#app',\n    data: {\n      test: 1,\n    },\n  },\n  vm\n)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Parent component options:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"vm.$options = {\n  components: {\n    KeepAlive,\n    Transition,\n    TransitionGroup,\n    ...UserRegisterComponents,\n  },\n  created: [\n    function created() {\n      console.log('parent created')\n    },\n  ],\n  directives: {\n    model,\n    show,\n    ...userCustomDirectives,\n  },\n  filters: {},\n  _base: function Vue(options) {},\n  el: '#app',\n  render: function _render(h) {},\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Children component options:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"vm.$options = {\n  parent: Vue /* \u7236Vue\u5b9e\u4f8b */,\n  propsData: undefined,\n  _componentTag: undefined,\n  _parentVnode: VNode /* \u7236VNode\u5b9e\u4f8b */,\n  _renderChildren: undefined,\n  __proto__: {\n    components: {\n      KeepAlive,\n      Transition,\n      TransitionGroup,\n      ...UserRegisterComponents,\n    },\n    directives: {\n      model,\n      show,\n      ...userCustomDirectives,\n    },\n    filters: {},\n    _base: function Vue(options) {},\n    _Ctor: {},\n    created: [\n      function created() {\n        console.log('parent created')\n      },\n      function created() {\n        console.log('child created')\n      },\n    ],\n    mounted: [\n      function mounted() {\n        console.log('child mounted')\n      },\n    ],\n    data() {\n      return {\n        msg: 'Hello Vue',\n      }\n    },\n    template: '<div>{{msg}}</div>',\n  },\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"core/instance/state.js/initProps()"}),": ",(0,i.jsx)(n.code,{children:"this.XXX"})," -> ",(0,i.jsx)(n.code,{children:"this._props.XXX"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"core/instance/state.js/initData()"}),": ",(0,i.jsx)(n.code,{children:"this.XXX"})," -> ",(0,i.jsx)(n.code,{children:"this._data.XXX"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"vue-merge-options",children:"Vue Merge Options"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"mergeOptions"})," (",(0,i.jsx)(n.code,{children:"core/util/options.js"}),"):"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"el"}),"/",(0,i.jsx)(n.code,{children:"propsData"})," \u9009\u9879\u4f7f\u7528\u9ed8\u8ba4\u7684\u5408\u5e76\u7b56\u7565 ",(0,i.jsx)(n.code,{children:"defaultStrategy"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"data"})," \u9009\u9879, \u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"mergeDataOrFn"})," \u51fd\u6570\u8fdb\u884c\u5904\u7406, \u6700\u7ec8\u7ed3\u679c\u662f ",(0,i.jsx)(n.code,{children:"data"})," \u9009\u9879\u5c06\u53d8\u6210\u4e00\u4e2a\u51fd\u6570, \u4e14\u8be5\u51fd\u6570\u7684\u6267\u884c\u7ed3\u679c\u4e3a\u771f\u6b63\u7684\u6570\u636e\u5bf9\u8c61."]}),"\n",(0,i.jsx)(n.li,{children:"\u5bf9\u4e8e \u751f\u547d\u5468\u671f\u94a9\u5b50 \u9009\u9879, \u5c06\u5408\u5e76\u6210\u6570\u7ec4, \u4f7f\u5f97\u7236\u5b50\u9009\u9879\u4e2d\u7684\u94a9\u5b50\u51fd\u6570\u90fd\u80fd\u591f\u88ab\u6267\u884c."}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"directives"}),"/",(0,i.jsx)(n.code,{children:"filters"})," \u4ee5\u53ca ",(0,i.jsx)(n.code,{children:"components"})," \u7b49\u8d44\u6e90\u9009\u9879,\n\u7236\u5b50\u9009\u9879\u5c06\u4ee5\u539f\u578b\u94fe\u7684\u5f62\u5f0f\u88ab\u5904\u7406, \u6b63\u662f\u56e0\u4e3a\u8fd9\u6837\u6211\u4eec\u624d\u80fd\u591f\u5728\u4efb\u4f55\u5730\u65b9\u90fd\u4f7f\u7528\u5185\u7f6e\u7ec4\u4ef6\u6216\u6307\u4ee4\u7b49."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"watch"})," \u9009\u9879\u7684\u5408\u5e76\u5904\u7406, \u7c7b\u4f3c\u4e8e\u751f\u547d\u5468\u671f\u94a9\u5b50, \u5982\u679c\u7236\u5b50\u9009\u9879\u90fd\u6709\u76f8\u540c\u7684\u89c2\u6d4b\u5b57\u6bb5, \u5c06\u88ab\u5408\u5e76\u4e3a\u6570\u7ec4, \u8fd9\u6837\u89c2\u5bdf\u8005\u90fd\u5c06\u88ab\u6267\u884c."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"props"}),"/",(0,i.jsx)(n.code,{children:"methods"}),"/",(0,i.jsx)(n.code,{children:"inject"}),"/",(0,i.jsx)(n.code,{children:"computed"})," \u9009\u9879, \u7236\u9009\u9879\u59cb\u7ec8\u53ef\u7528, \u4f46\u662f\u5b50\u9009\u9879\u4f1a\u8986\u76d6\u540c\u540d\u7684\u7236\u9009\u9879\u5b57\u6bb5."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e ",(0,i.jsx)(n.code,{children:"provide"})," \u9009\u9879, \u5176\u5408\u5e76\u7b56\u7565\u4f7f\u7528\u4e0e ",(0,i.jsx)(n.code,{children:"data"})," \u9009\u9879\u76f8\u540c\u7684 ",(0,i.jsx)(n.code,{children:"mergeDataOrFn"})," \u51fd\u6570."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6700\u540e, \u4ee5\u4e0a\u6ca1\u6709\u63d0\u53ca\u5230\u7684\u9009\u9879\u90fd\u5c06\u4f7f\u9ed8\u8ba4\u9009\u9879 ",(0,i.jsx)(n.code,{children:"defaultStrategy"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u6700\u6700\u540e, \u9ed8\u8ba4\u5408\u5e76\u7b56\u7565\u51fd\u6570 ",(0,i.jsx)(n.code,{children:"defaultStrategy"})," \u7684\u7b56\u7565\u662f: \u53ea\u8981\u5b50\u9009\u9879\u4e0d\u662f ",(0,i.jsx)(n.code,{children:"undefined"})," \u5c31\u4f7f\u7528\u5b50\u9009\u9879, \u5426\u5219\u4f7f\u7528\u7236\u9009\u9879."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/**\n * Merge two option objects into a new one.\n * Core utility used in both instantiation and inheritance.\n */\nexport function mergeOptions(\n  parent: object,\n  child: object,\n  vm?: Component\n): object {\n  if (typeof child === 'function')\n    child = child.options\n\n  normalizeProps(child, vm)\n  normalizeInject(child, vm)\n  normalizeDirectives(child)\n\n  const extendsFrom = child.extends\n\n  if (extendsFrom)\n    parent = mergeOptions(parent, extendsFrom, vm)\n\n  if (child.mixins) {\n    for (let i = 0, l = child.mixins.length; i < l; i++)\n      parent = mergeOptions(parent, child.mixins[i], vm)\n  }\n\n  const options = {}\n  let key\n\n  for (key in parent) mergeField(key)\n\n  for (key in child) {\n    if (!hasOwn(parent, key))\n      mergeField(key)\n  }\n\n  function mergeField(key) {\n    const strategy = strategies[key] || defaultStrategy\n    options[key] = strategy(parent[key], child[key], vm, key)\n  }\n\n  return options\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-normalize-options",children:"Vue Normalize Options"}),"\n",(0,i.jsx)(n.p,{children:"Props:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export default {\n  props: {\n    someData1: {\n      type: Number,\n    },\n    someData2: {\n      type: String,\n      default: '',\n    },\n  },\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Injects:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export default {\n  inject: {\n    data1: { from: 'data1' },\n    d2: { from: 'data2' },\n    data3: { from: 'data3', someProperty: 'someValue' },\n  },\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Directives:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"for (const key in dirs) {\n  const def = dirs[key]\n  if (typeof def === 'function')\n    dirs[key] = { bind: def, update: def }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-mounting-workflow",children:"Vue Mounting Workflow"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"new Vue()"})," -> \u521d\u59cb\u5316 -> \u7f16\u8bd1 -> \u6e32\u67d3 -> \u6302\u8f7d -> \u66f4\u65b0:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"new Vue()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.prototype._init"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.prototype.$mount"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"vm.$options.render = compileToFunctions(vm.$options.template)"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"vue-loader"})," for static transform:\n",(0,i.jsx)(n.code,{children:".vue"})," -> ",(0,i.jsx)(n.code,{children:".js"})," in build time."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"compileToFunctions"})," for runtime transform:\nbundle ",(0,i.jsx)(n.code,{children:"compiler"})," and ",(0,i.jsx)(n.code,{children:"runtime"})," into ",(0,i.jsx)(n.code,{children:"vue.js"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"mountComponent(vm, el)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.prototype._render"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"VDOM.createElement(vm)"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Normalize children."}),"\n",(0,i.jsx)(n.li,{children:"Create VNode and install hooks."}),"\n",(0,i.jsx)(n.li,{children:"Create children recursively."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.prototype._update"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue.prototype.__patch__"})," (",(0,i.jsx)(n.code,{children:"platforms/web/runtime/patch.js"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"backend.nodeOps"})," (",(0,i.jsx)(n.code,{children:"platforms/web/runtime/node-ops"}),").","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"createElement"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"createElementNS"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"createTextNode"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"createComment"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"insertBefore"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"appendChild"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"removeChild"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"parentNode"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"nextSibling"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"tagName"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setTextContent"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setStyleScope"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"backend.hooksModules"})," (",(0,i.jsx)(n.code,{children:"core/vdom/modules"})," + ",(0,i.jsx)(n.code,{children:"platforms/web/runtime/modules"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"create"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"activate"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"update"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"remove"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"destroy"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const app = new Vue({ el: '#app', ...restOptionsAPI })\nvm._init(...restOptionsAPI)\nif (vm.$options.el)\n  vm.$mount(vm.$options.el)\nvm.$options.render = compileToFunctions(vm.$options.template)\nmountComponent(vm, el)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/init.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5408\u5e76\u914d\u7f6e."}),"\n",(0,i.jsx)(n.li,{children:"\u521d\u59cb\u5316\u751f\u547d\u5468\u671f."}),"\n",(0,i.jsx)(n.li,{children:"\u521d\u59cb\u5316\u4e8b\u4ef6\u4e2d\u5fc3."}),"\n",(0,i.jsx)(n.li,{children:"\u521d\u59cb\u5316\u6e32\u67d3."}),"\n",(0,i.jsx)(n.li,{children:"\u521d\u59cb\u5316 data/props/computed/watcher."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// initMixin(Vue)\nVue.prototype._init = function (options?: object) {\n  // eslint-disable-next-line ts/no-this-alias\n  const vm: Component = this\n\n  // uid\n  vm._uid = uid++\n\n  // a flag to avoid this being observed\n  vm._isVue = true\n\n  // merge options\n  if (options && options._isComponent) {\n    initInternalComponent(vm, options)\n  } else {\n    vm.$options = mergeOptions(\n      resolveConstructorOptions(vm.constructor),\n      options || {},\n      vm\n    )\n  }\n\n  vm._renderProxy = vm\n\n  // expose real self\n  vm._self = vm\n  initLifecycle(vm)\n  initEvents(vm)\n  initRender(vm)\n  callHook(vm, 'beforeCreate')\n  initInjections(vm) // resolve injections before data/props\n  initState(vm)\n  initProvide(vm) // resolve provide after data/props\n  callHook(vm, 'created')\n\n  if (vm.$options.el)\n    vm.$mount(vm.$options.el)\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function mountComponent(\n  vm: Component,\n  el: ?Element,\n  hydrating?: boolean\n): Component {\n  vm.$el = el\n\n  if (!vm.$options.render)\n    vm.$options.render = createEmptyVNode\n\n  callHook(vm, 'beforeMount')\n\n  const updateComponent = () => {\n    vm._update(vm._render(), hydrating)\n  }\n\n  // eslint-disable-next-line no-new\n  new Watcher(\n    vm,\n    updateComponent,\n    noop,\n    {\n      before() {\n        if (vm._isMounted)\n          callHook(vm, 'beforeUpdate')\n      },\n    },\n    true /* isRenderWatcher */\n  )\n\n  hydrating = false\n\n  // manually mounted instance, call mounted on self\n  // mounted is called for render-created child components in its inserted hook\n  // vm.$vnode \u8868\u793a Vue \u5b9e\u4f8b\u7684\u7236\u865a\u62df Node.\n  if (vm.$vnode == null) {\n    // Only `new Vue()` trigger this:\n    vm._isMounted = true\n    callHook(vm, 'mounted')\n  }\n\n  return vm\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/render.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Vue.prototype._render = function (): VNode {\n  // eslint-disable-next-line ts/no-this-alias\n  const vm: Component = this\n  const { render, _parentVnode } = vm.$options\n\n  if (_parentVnode)\n    vm.$scopedSlots = _parentVnode.data.scopedSlots || emptyObject\n\n  // set parent vnode. this allows render functions to have access\n  // to the data on the placeholder node.\n  vm.$vnode = _parentVnode\n\n  // render self\n  const vnode = render.call(vm._renderProxy, vm.$createElement)\n\n  // return empty vnode in case the render function errored out\n  if (!(vnode instanceof VNode))\n    vnode = createEmptyVNode()\n\n  // set parent\n  vnode.parent = _parentVnode\n  return vnode\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/vdom/create-element.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Normalize children: transform children to ",(0,i.jsx)(n.code,{children:"Array<VNode>"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Create VNode:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"new VNode(tag, data, children, vm)"})," for native host elements (e.g ",(0,i.jsx)(n.code,{children:"<div>"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"createComponent(tag, data, children, vm)"})," for custom components:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"resolveConstructorOptions"}),": merge and resolve options API."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"installComponentHooks"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Install internal (",(0,i.jsx)(n.code,{children:"core/vdom/create-component.js/componentVNodeHooks"}),") hooks."]}),"\n",(0,i.jsx)(n.li,{children:"Merge user-defined VNode hooks."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["new VNode(",(0,i.jsx)(n.code,{children:"vue-component-${Ctor.options.name}"}),", data, undefined, vm)."]}),"\n",(0,i.jsxs)(n.li,{children:["Component VNode children is ",(0,i.jsx)(n.code,{children:"undefined"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"vm._vnode.parent === vm.$vnode"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["\u7ec4\u4ef6 patch \u8fc7\u7a0b\u4e2d DOM \u7684\u63d2\u5165\u987a\u5e8f\u4e3a",(0,i.jsx)(n.strong,{children:"\u5148\u5b50\u540e\u7236"}),":\n",(0,i.jsx)(n.code,{children:"createComponent(vnode)"})," \u4e2d\u4f1a\u8c03\u7528\u5185\u90e8\u94a9\u5b50\u51fd\u6570 ",(0,i.jsx)(n.code,{children:"init(vnode)"}),",\n",(0,i.jsx)(n.code,{children:"init(vnode)"})," \u51fd\u6570\u4f1a\u521b\u5efa\u5b50\u7ec4\u4ef6 ",(0,i.jsx)(n.code,{children:"VNode"}),", \u5e76\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"child.$mount(vnode.elm)"}),",\n\u9012\u5f52\u5f0f\u5730\u521b\u5efa\u5b50\u7ec4\u4ef6."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function createElement(\n  context: Component,\n  tag: any,\n  data: any,\n  children: any,\n  normalizationType: any,\n  alwaysNormalize: boolean\n): VNode | Array<VNode> {\n  if (Array.isArray(data) || isPrimitive(data)) {\n    normalizationType = children\n    children = data\n    data = undefined\n  }\n\n  if (isTrue(alwaysNormalize))\n    normalizationType = ALWAYS_NORMALIZE\n\n  return _createElement(context, tag, data, children, normalizationType)\n}\n\nexport function _createElement(\n  context: Component,\n  tag?: string | Class<Component> | Function | object,\n  data?: VNodeData,\n  children?: any,\n  normalizationType?: number\n): VNode | Array<VNode> {\n  if (isDef(data) && isDef(data.__ob__))\n    return createEmptyVNode()\n\n  // object syntax in v-bind\n  if (isDef(data) && isDef(data.is))\n    tag = data.is\n\n  if (!tag) {\n    // in case of component :is set to falsy value\n    return createEmptyVNode()\n  }\n\n  // support single function children as default scoped slot\n  if (Array.isArray(children) && typeof children[0] === 'function') {\n    data = data || {}\n    data.scopedSlots = { default: children[0] }\n    children.length = 0\n  }\n\n  if (normalizationType === ALWAYS_NORMALIZE)\n    children = normalizeChildren(children)\n  else if (normalizationType === SIMPLE_NORMALIZE)\n    children = simpleNormalizeChildren(children)\n\n  let vnode\n  let ns\n\n  if (typeof tag === 'string') {\n    let Ctor\n    ns = (context.$vnode && context.$vnode.ns) || config.getTagNamespace(tag)\n\n    if (config.isReservedTag(tag)) {\n      // platform built-in elements\n      vnode = new VNode(\n        config.parsePlatformTagName(tag),\n        data,\n        children,\n        undefined,\n        undefined,\n        context\n      )\n    } else if (\n      (!data || !data.pre)\n      // eslint-disable-next-line no-cond-assign\n      && isDef((Ctor = resolveAsset(context.$options, 'components', tag)))\n    ) {\n      // component\n      vnode = createComponent(Ctor, data, context, children, tag)\n    } else {\n      // unknown or unlisted namespaced elements\n      // check at runtime because it may get assigned a namespace when its\n      // parent normalizes children\n      vnode = new VNode(tag, data, children, undefined, undefined, context)\n    }\n  } else {\n    // direct component options / constructor\n    vnode = createComponent(tag, data, context, children)\n  }\n\n  if (Array.isArray(vnode)) {\n    return vnode\n  } else if (isDef(vnode)) {\n    if (isDef(ns))\n      applyNS(vnode, ns)\n    if (isDef(data))\n      registerDeepBindings(data)\n    return vnode\n  } else {\n    return createEmptyVNode()\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Vue.prototype._update = function (vnode: VNode, hydrating?: boolean) {\n  // eslint-disable-next-line ts/no-this-alias\n  const vm: Component = this\n  const prevEl = vm.$el\n  const prevVnode = vm._vnode\n  const restoreActiveInstance = setActiveInstance(vm)\n  vm._vnode = vnode\n\n  // Vue.prototype.__patch__ is injected in entry points\n  // based on the rendering backend used.\n  if (!prevVnode) {\n    // initial render\n    vm.$el = vm.__patch__(vm.$el, vnode, hydrating, false /* removeOnly */)\n  } else {\n    // updates\n    vm.$el = vm.__patch__(prevVnode, vnode)\n  }\n\n  restoreActiveInstance()\n\n  // update __vue__ reference\n  if (prevEl)\n    prevEl.__vue__ = null\n\n  if (vm.$el)\n    vm.$el.__vue__ = vm\n\n  // if parent is an HOC, update its $el as well\n  if (vm.$vnode && vm.$parent && vm.$vnode === vm.$parent._vnode)\n    vm.$parent.$el = vm.$el\n\n  // updated hook is called by the scheduler\n  // to ensure that children are updated in a parent's updated hook.\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-lifecycle",children:"Vue Lifecycle"}),"\n",(0,i.jsx)(n.h3,{id:"vue-options-lifecycle",children:"Vue Options Lifecycle"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://v2.vuejs.org/v2/api/#Options-Lifecycle-Hooks",children:(0,i.jsx)(n.img,{alt:"Lifecycle",src:t(9228).A+"",width:"1200",height:"3039"})})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"callHook"})," in ",(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function callHook(vm: Component, hook: string) {\n  pushTarget()\n  const handlers = vm.$options[hook]\n\n  if (handlers) {\n    for (let i = 0, j = handlers.length; i < j; i++) {\n      try {\n        handlers[i].call(vm)\n      } catch (e) {\n        handleError(e, vm, `${hook} hook`)\n      }\n    }\n  }\n\n  if (vm._hasHookEvent)\n    vm.$emit(`hook:${hook}`)\n\n  popTarget()\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"beforeCreate"}),"/",(0,i.jsx)(n.code,{children:"created"})," in ",(0,i.jsx)(n.code,{children:"core/instance/init.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"beforeCreate"})," \u4e0d\u80fd\u8bbf\u95ee ",(0,i.jsx)(n.code,{children:"props"}),"/",(0,i.jsx)(n.code,{children:"data"}),"/",(0,i.jsx)(n.code,{children:"methods"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"created"})," \u53ef\u4ee5\u8bbf\u95ee ",(0,i.jsx)(n.code,{children:"props"}),"/",(0,i.jsx)(n.code,{children:"data"}),"/",(0,i.jsx)(n.code,{children:"methods"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"beforeCreate"}),"/",(0,i.jsx)(n.code,{children:"created"})," \u4e0d\u80fd\u8bbf\u95ee DOM."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Vue.prototype._init = function (options?: object) {\n  // ...\n  initLifecycle(vm)\n  initEvents(vm)\n  initRender(vm)\n  callHook(vm, 'beforeCreate')\n  initInjections(vm)\n  initState(vm) // props/data/methods/watch/computed.\n  initProvide(vm)\n  callHook(vm, 'created')\n  // ...\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"beforeMount"}),"/",(0,i.jsx)(n.code,{children:"beforeUpdate"})," in ",(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export function mountComponent(\n  vm: Component,\n  el: ?Element,\n  hydrating?: boolean\n): Component {\n  vm.$el = el\n  // ...\n  callHook(vm, 'beforeMount')\n\n  const updateComponent = () => {\n    vm._update(vm._render(), hydrating)\n  }\n\n  // eslint-disable-next-line no-new\n  new Watcher(\n    vm,\n    updateComponent,\n    noop,\n    {\n      before() {\n        if (vm._isMounted)\n          callHook(vm, 'beforeUpdate')\n      },\n    },\n    true /* isRenderWatcher */\n  )\n\n  hydrating = false\n\n  if (vm.$vnode == null) {\n    // Only `new Vue()` trigger this:\n    vm._isMounted = true\n    callHook(vm, 'mounted')\n  }\n\n  return vm\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"mounted"})," in ",(0,i.jsx)(n.code,{children:"core/vdom/patch.js"}),"/",(0,i.jsx)(n.code,{children:"core/vdom/create-component.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u4e8e\u540c\u6b65\u6e32\u67d3\u7684\u5b50\u7ec4\u4ef6, ",(0,i.jsx)(n.code,{children:"mounted"})," \u6267\u884c\u987a\u5e8f\u4e3a",(0,i.jsx)(n.strong,{children:"\u5148\u5b50\u540e\u7236"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// core/vdom/patch.js:\nfunction invokeInsertHook(vnode, queue, initial) {\n  // delay insert hooks for component root nodes, invoke them after the\n  // element is really inserted\n  if (isTrue(initial) && isDef(vnode.parent)) {\n    vnode.parent.data.pendingInsert = queue\n  } else {\n    for (let i = 0; i < queue.length; ++i) queue[i].data.hook.insert(queue[i])\n  }\n}\n\n// core/vdom/create-component.js:\nconst componentVNodeHooks = {\n  // ...\n  insert(vnode: MountedComponentVNode) {\n    const { context, componentInstance } = vnode\n    if (!componentInstance._isMounted) {\n      componentInstance._isMounted = true\n      callHook(componentInstance, 'mounted')\n    }\n    // ...\n  },\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"update"})," in ",(0,i.jsx)(n.code,{children:"core/observer/scheduler.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RenderWatcher"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function flushSchedulerQueue() {\n  // ...\n  // \u83b7\u53d6\u5230 updatedQueue\n  callUpdatedHooks(updatedQueue)\n}\n\nfunction callUpdatedHooks(queue) {\n  let i = queue.length\n\n  while (i--) {\n    const watcher = queue[i]\n    const vm = watcher.vm\n\n    // Peek up `RenderWatcher`\n    if (vm._watcher === watcher && vm._isMounted)\n      callHook(vm, 'updated')\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"beforeDestroy"}),"/",(0,i.jsx)(n.code,{children:"destroyed"})," in ",(0,i.jsx)(n.code,{children:"core/instance/lifecycle.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"beforeDestroy"})," \u94a9\u5b50\u51fd\u6570."]}),"\n",(0,i.jsxs)(n.li,{children:["\u4ece ",(0,i.jsx)(n.code,{children:"parent"})," \u7684 ",(0,i.jsx)(n.code,{children:"$children"})," \u4e2d\u5220\u6389\u81ea\u8eab."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5220\u9664 ",(0,i.jsx)(n.code,{children:"watcher"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"\u5f53\u524d\u6e32\u67d3\u7684 VNode \u6267\u884c\u9500\u6bc1\u94a9\u5b50\u51fd\u6570."}),"\n",(0,i.jsxs)(n.li,{children:["\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"destroyed"})," \u94a9\u5b50\u51fd\u6570."]}),"\n",(0,i.jsxs)(n.li,{children:["\u5728 ",(0,i.jsx)(n.code,{children:"$destroy"})," \u7684\u6267\u884c\u8fc7\u7a0b\u4e2d,\n\u4f1a\u6267\u884c ",(0,i.jsx)(n.code,{children:"vm.__patch__(vm._vnode, null)"})," \u89e6\u53d1\u5b50\u7ec4\u4ef6\u7684\u9500\u6bc1\u94a9\u5b50\u51fd\u6570 (\u9012\u5f52),\n",(0,i.jsx)(n.code,{children:"destroyed"})," \u94a9\u5b50\u51fd\u6570\u6267\u884c\u987a\u5e8f\u4e3a",(0,i.jsx)(n.strong,{children:"\u5148\u5b50\u540e\u7236"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Vue.prototype.$destroy = function () {\n  // eslint-disable-next-line ts/no-this-alias\n  const vm: Component = this\n\n  if (vm._isBeingDestroyed)\n    return\n\n  callHook(vm, 'beforeDestroy')\n  vm._isBeingDestroyed = true\n\n  // remove self from parent\n  const parent = vm.$parent\n\n  if (parent && !parent._isBeingDestroyed && !vm.$options.abstract)\n    remove(parent.$children, vm)\n\n  // teardown watchers\n  if (vm._watcher)\n    vm._watcher.teardown()\n\n  let i = vm._watchers.length\n\n  while (i--) vm._watchers[i].teardown()\n\n  // remove reference from data ob\n  // frozen object may not have observer.\n  if (vm._data.__ob__)\n    vm._data.__ob__.vmCount--\n\n  // call the last hook...\n  vm._isDestroyed = true\n  // invoke destroy hooks on current rendered tree\n  vm.__patch__(vm._vnode, null)\n  // fire destroyed hook\n  callHook(vm, 'destroyed')\n  // turn off all instance listeners.\n  vm.$off()\n\n  // GC: remove __vue__ reference\n  if (vm.$el)\n    vm.$el.__vue__ = null\n\n  // GC: release circular reference (#6759)\n  if (vm.$vnode)\n    vm.$vnode.parent = null\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-composition-lifecycle",children:"Vue Composition Lifecycle"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"let currentInstance = null\nfunction setCurrentInstance(instance) {\n  currentInstance = instance\n}\n\nfunction mountComponent(vnode, container, anchor) {\n  const componentOptions = vnode.type\n  const { setup, data, props, attrs, slots } = componentOptions\n  const instance = {\n    state: reactive(data),\n    props: shallowReadonly(props),\n    isMounted: false,\n    subTree: null,\n    slots,\n    mounted: [],\n  }\n\n  const setupContext = { attrs, slots }\n  setCurrentInstance(instance)\n  const setupResult = setup(shallowReadonly(instance.props), setupContext)\n  setCurrentInstance(null)\n\n  effect(\n    () => {\n      const subTree = render.call(renderContext, renderContext)\n\n      if (!instance.mounted)\n        instance.mounted?.forEach(hook => hook.call(renderContext))\n    },\n    {\n      scheduler: queueJob,\n    }\n  )\n}\n\nfunction onMounted(fn) {\n  if (currentInstance)\n    currentInstance.mounted.push(fn)\n  else console.error('`onMounted().` can only called in `setup()`.')\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-instance",children:"Vue Instance"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// Vue.prototype._init: core/instance/init.js\n// eslint-disable-next-line ts/no-this-alias\nconst vm: Component = this\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// Vue.prototype._init: core/instance/init.js\nvm._uid = uid++ // \u6bcf\u4e2aVue\u5b9e\u4f8b\u90fd\u62e5\u6709\u4e00\u4e2a\u552f\u4e00\u7684 id\nvm._isVue = true // \u8fd9\u4e2a\u8868\u793a\u7528\u4e8e\u907f\u514dVue\u5b9e\u4f8b\u5bf9\u8c61\u88ab\u89c2\u6d4b(observed)\nvm.$options = options // \u5f53\u524d Vue \u5b9e\u4f8b\u7684\u521d\u59cb\u5316\u9009\u9879, \u6ce8\u610f: \u8fd9\u662f\u7ecf\u8fc7 mergeOptions() \u540e\u7684\nvm._renderProxy = vm // \u6e32\u67d3\u51fd\u6570\u4f5c\u7528\u57df\u4ee3\u7406\nvm._self = vm // \u5b9e\u4f8b\u672c\u8eab\n\n// initLifecycle(vm): core/instance/lifecycle.js\nvm.$parent = vmParent\nvm.$root = vmParent ? vmParent.$root : vm\n\nvm.$children = []\nvm.$refs = {}\n\nvm._watcher = null\nvm._inactive = null\nvm._directInactive = false\nvm._isMounted = false\nvm._isDestroyed = false\nvm._isBeingDestroyed = false\n\n// initEvents(vm): core/instance/events.js\nvm._events = Object.create(null)\nvm._hasHookEvent = false\n\n// initRender(vm): core/instance/render.js\nvm._vnode = null // the root of the child tree\nvm._staticTrees = null // v-once cached trees\n\nvm.$vnode = vnode\nvm.$slots = slots\nvm.$scopedSlots = scopedSlots\n\nvm._c = c\nvm.$createElement = createElement\n\nvm.$attrs = attrs\nvm.$listeners = listeners\n\n// initState(vm): core/instance/state.js\nvm._watchers = []\nvm._data = data\n\n// mountComponent(): core/instance/lifecycle.js\nvm.$el = el\n\n// initComputed(): core/instance/state.js\nvm._computedWatchers = Object.create(null)\n\n// initProps(): core/instance/state.js\nvm._props = {}\n\n// initProvide(): core/instance/inject.js\nvm._provided = provided\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-virtual-dom",children:"Vue Virtual DOM"}),"\n",(0,i.jsx)(n.p,{children:"VNode Type:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"HTML native tag."}),"\n",(0,i.jsx)(n.li,{children:"Plain text."}),"\n",(0,i.jsxs)(n.li,{children:["Component:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Functional component."}),"\n",(0,i.jsxs)(n.li,{children:["Stateful component:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Normal stateful component."}),"\n",(0,i.jsx)(n.li,{children:"Need keep-alive stateful component."}),"\n",(0,i.jsx)(n.li,{children:"Already keep-alive stateful component."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Fragment."}),"\n",(0,i.jsx)(n.li,{children:"Portal."}),"\n",(0,i.jsx)(n.li,{children:"Suspense."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"export default class VNode {\n  tag: string | void\n  data: VNodeData | void\n  children: Array<VNode> | null\n  text: string | void\n  elm: Node | void\n  ns: string | void\n  context: Component | void // rendered in this component's scope\n  key: string | number | void\n  componentOptions: VNodeComponentOptions | void\n  componentInstance: Component | void // component instance\n  parent: VNode | void // component placeholder node\n\n  // strictly internal\n  raw: boolean // contains raw HTML? (server only)\n  isStatic: boolean // hoisted static node\n  isRootInsert: boolean // necessary for enter transition check\n  isComment: boolean // empty comment placeholder?\n  isCloned: boolean // is a cloned node?\n  isOnce: boolean // is a v-once node?\n  asyncFactory: Function | void // async component factory function\n  asyncMeta: object | void\n  isAsyncPlaceholder: boolean\n  ssrContext: object | void\n  fnContext: Component | void // real context vm for functional nodes\n  fnOptions: ComponentOptions | null // for SSR caching\n  fnScopeId: string | null // functional scope id support\n\n  constructor(\n    tag?: string,\n    data?: VNodeData,\n    children?: Array<VNode> | null,\n    text?: string,\n    elm?: Node,\n    context?: Component,\n    componentOptions?: VNodeComponentOptions,\n    asyncFactory?: Function\n  ) {\n    this.tag = tag\n    this.data = data\n    this.children = children\n    this.text = text\n    this.elm = elm\n    this.ns = undefined\n    this.context = context\n    this.fnContext = undefined\n    this.fnOptions = undefined\n    this.fnScopeId = undefined\n    this.key = data && data.key\n    this.componentOptions = componentOptions\n    this.componentInstance = undefined\n    this.parent = undefined\n    this.raw = false\n    this.isStatic = false\n    this.isRootInsert = true\n    this.isComment = false\n    this.isCloned = false\n    this.isOnce = false\n    this.asyncFactory = asyncFactory\n    this.asyncMeta = undefined\n    this.isAsyncPlaceholder = false\n  }\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const VNodeFlags = {\n  ELEMENT_HTML: 1,\n  ELEMENT_SVG: 1 << 1,\n  COMPONENT_STATEFUL_NORMAL: 1 << 2,\n  COMPONENT_STATEFUL_SHOULD_KEEP_ALIVE: 1 << 3,\n  COMPONENT_STATEFUL_KEPT_ALIVE: 1 << 4,\n  COMPONENT_FUNCTIONAL: 1 << 5,\n  TEXT: 1 << 6,\n  FRAGMENT: 1 << 7,\n  PORTAL: 1 << 8,\n}\n\nVNodeFlags.ELEMENT = VNodeFlags.ELEMENT_HTML | VNodeFlags.ELEMENT_SVG\n\nVNodeFlags.COMPONENT_STATEFUL\n  = VNodeFlags.COMPONENT_STATEFUL_NORMAL\n  | VNodeFlags.COMPONENT_STATEFUL_SHOULD_KEEP_ALIVE\n  | VNodeFlags.COMPONENT_STATEFUL_KEPT_ALIVE\n\nVNodeFlags.COMPONENT\n  = VNodeFlags.COMPONENT_STATEFUL | VNodeFlags.COMPONENT_FUNCTIONAL\n\nconst ChildrenFlags = {\n  // \u672a\u77e5\u7684 children \u7c7b\u578b.\n  UNKNOWN_CHILDREN: 0,\n  // \u6ca1\u6709 children.\n  NO_CHILDREN: 1,\n  // children \u662f\u5355\u4e2a VNode.\n  SINGLE_VNODE: 1 << 1,\n  // children \u662f\u591a\u4e2a\u62e5\u6709 key \u7684 VNode.\n  KEYED_VNODES: 1 << 2,\n  // children \u662f\u591a\u4e2a\u6ca1\u6709 key \u7684 VNode.\n  NONE_KEYED_VNODES: 1 << 3,\n}\n\nChildrenFlags.MULTIPLE_VNODES\n  = ChildrenFlags.KEYED_VNODES | ChildrenFlags.NONE_KEYED_VNODES\n\nexport interface VNode {\n  _isVNode: true\n  // Refer to real DOM.\n  el: Element | null\n  flags: VNodeFlags\n  tag: string | FunctionalComponent | ComponentClass | null\n  data: VNodeData | null\n  children: VNodeChildren\n  childFlags: ChildrenFlags\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-template-and-compiler",children:"Vue Template and Compiler"}),"\n",(0,i.jsx)(n.h3,{id:"vue-compilation-workflow",children:"Vue Compilation Workflow"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function compile(template: string, options: CompilerOptions): CompiledResult {\n  const ast = parse(template.trim(), options)\n  optimize(ast, options)\n  const code = generate(ast, options)\n\n  return {\n    ast,\n    render: code.render,\n    staticRenderFns: code.staticRenderFns,\n  }\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"template \u5c5e\u6027\u5b58\u5728, render \u65b9\u6cd5\u4e0d\u5b58\u5728\u65f6:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"runtime with compiler \u7248\u672c\u4f1a\u5728 JavaScript \u8fd0\u884c\u65f6\u8fdb\u884c\u6a21\u677f\u7f16\u8bd1, \u751f\u6210 render \u51fd\u6570."}),"\n",(0,i.jsxs)(n.li,{children:["runtime only \u7248\u672c\u4f1a\u6253\u5370\u8b66\u544a\u4fe1\u606f, \u63d0\u793a\u7528\u6237\u4f7f\u7528 runtime with compiler \u7248\u672c\u6216\u8005\u4f7f\u7528\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"vue-loader"})," \u8fdb\u884c\u9759\u6001\u7f16\u8bd1."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"vue-compilation-performance",children:"Vue Compilation Performance"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Shorten template helper function with prefix ",(0,i.jsx)(n.code,{children:"_v"}),"/",(0,i.jsx)(n.code,{children:"_s"})," etc."]}),"\n",(0,i.jsx)(n.li,{children:"Hoist static template blocks,\neliminate unnecessary virtual DOM diff effort,\nonly track dynamic VNode."}),"\n",(0,i.jsxs)(n.li,{children:["Cache event handlers (React ",(0,i.jsx)(n.code,{children:"useCallback"}),"):\n\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u7ed1\u5b9a\u4e8b\u4ef6\u884c\u4e3a\u4f1a\u88ab\u89c6\u4e3a\u52a8\u6001\u7ed1\u5b9a,\n\u6240\u4ee5\u6bcf\u6b21\u90fd\u4f1a\u53bb\u8ffd\u8e2a\u5b83\u7684\u53d8\u5316,\n\u5f00\u542f\u4e8b\u4ef6\u4fa6\u542c\u5668\u7f13\u5b58\u540e,\n\u76f4\u63a5\u590d\u7528\u4e8b\u4ef6\u5904\u7406\u5668."]}),"\n",(0,i.jsx)(n.li,{children:"Tree flattening:\n\u6bcf\u4e00\u4e2a\u533a\u5757\u90fd\u4f1a\u8ffd\u8e2a\u5176\u6240\u6709\u5e26\u66f4\u65b0\u7c7b\u578b\u6807\u8bb0\u7684\u540e\u4ee3\u8282\u70b9,\n\u5728\u6fc0\u6d3b\u65f6\u53ea\u6709\u533a\u5757\u8282\u70b9\u548c\u5176\u52a8\u6001\u5b50\u8282\u70b9\u9700\u8981\u88ab\u904d\u5386,\n\u53ea\u9700\u8981\u904d\u5386\u6253\u5e73\u7684\u6811\u800c\u975e\u6574\u68f5\u6811 (\u9ad8\u6548\u7565\u8fc7\u6a21\u677f\u4e2d\u4efb\u4f55\u7684\u9759\u6001\u90e8\u5206),\n\u5927\u5927\u51cf\u5c11\u4e86\u5728\u865a\u62df DOM \u534f\u8c03\u65f6\u9700\u8981\u904d\u5386\u7684\u8282\u70b9\u6570\u91cf."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const enum PatchFlags {\n  TEXT = 1, // \u52a8\u6001\u7684\u6587\u672c\u8282\u70b9\n  CLASS = 1 << 1, // 2 \u52a8\u6001\u7684 class\n  STYLE = 1 << 2, // 4 \u52a8\u6001\u7684 style\n  PROPS = 1 << 3, // 8 \u52a8\u6001\u5c5e\u6027\uff0c\u4e0d\u5305\u62ec\u7c7b\u540d\u548c\u6837\u5f0f\n  FULL_PROPS = 1 << 4, // 16 \u52a8\u6001 key\uff0c\u5f53 key \u53d8\u5316\u65f6\u9700\u8981\u5b8c\u6574\u7684 diff \u7b97\u6cd5\u505a\u6bd4\u8f83\n  HYDRATE_EVENTS = 1 << 5, // 32 \u8868\u793a\u5e26\u6709\u4e8b\u4ef6\u76d1\u542c\u5668\u7684\u8282\u70b9\n  STABLE_FRAGMENT = 1 << 6, // 64 \u4e00\u4e2a\u4e0d\u4f1a\u6539\u53d8\u5b50\u8282\u70b9\u987a\u5e8f\u7684 Fragment\n  KEYED_FRAGMENT = 1 << 7, // 128 \u5e26\u6709 key \u5c5e\u6027\u7684 Fragment\n  UN_KEYED_FRAGMENT = 1 << 8, // 256 \u5b50\u8282\u70b9\u6ca1\u6709 key \u7684 Fragment\n  NEED_PATCH = 1 << 9, // 512\n  DYNAMIC_SLOTS = 1 << 10, // \u52a8\u6001 slot\n  HOISTED = -1, // \u7279\u6b8a\u6807\u5fd7\u662f\u8d1f\u6574\u6570\u8868\u793a\u6c38\u8fdc\u4e0d\u4f1a\u7528\u4f5c diff\n  BAIL = -2, // \u4e00\u4e2a\u7279\u6b8a\u7684\u6807\u5fd7\uff0c\u6307\u4ee3\u5dee\u5f02\u7b97\u6cd5\n}\n\nfunction isStatic(node: ASTNode): boolean {\n  if (node.type === 2) {\n    // expression\n    return false\n  }\n\n  if (node.type === 3) {\n    // text\n    return true\n  }\n\n  return !!(\n    node.pre\n    || (!node.hasBindings // no dynamic bindings\n      && !node.if\n      && !node.for // not v-if or v-for or v-else\n      && !isBuiltInTag(node.tag) // not a built-in\n      && isPlatformReservedTag(node.tag) // not a component\n      && !isDirectChildOfTemplateFor(node)\n      && Object.keys(node).every(isStaticKey))\n  )\n}\n\nfunction patchElement(n1, n2) {\n  if (n2.dynamicChildren) {\n    // Skip all static blocks.\n    patchBlockChildren(n1, n2)\n  } else {\n    patchChildren(n1, n2, el)\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-two-way-data-binding",children:"Vue Two-Way Data Binding"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"View-Model"}),": \u4e3b\u8981\u505a\u4e86\u4e24\u4ef6\u5fae\u5c0f\u7684\u4e8b\u60c5:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u4ece M \u5230 V \u7684\u6620\u5c04 (Data Binding), \u8fd9\u6837\u53ef\u4ee5\u5927\u91cf\u8282\u7701\u4eba\u8089\u6765 update View \u7684\u4ee3\u7801:\n\u901a\u8fc7 Proxy \u4ee3\u7406 Model, \u6bcf\u5f53\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"Model[property].set"})," \u65f6\u540c\u65f6\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"render"})]}),"\n",(0,i.jsx)(n.li,{children:"\u4ece V \u5230 M \u7684\u4e8b\u4ef6\u76d1\u542c (DOM Listeners), \u8fd9\u6837 Model \u4f1a\u968f\u7740 View \u89e6\u53d1\u4e8b\u4ef6\u800c\u6539\u53d8"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const _data = {\n  name: 'mark',\n}\n\n// new Proxy(target, handler);\nconst changeName = new Proxy(_data, {\n  set(obj, name, value) {\n    obj[name] = value\n    render()\n  },\n})\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Array.from(el.getElementsByTagName('input'))\n  .filter((ele) => {\n    return ele.getAttribute('v-model')\n  })\n  .forEach((input) => {\n    const name = input.getAttribute('v-model')\n    input.value = changeName[name]\n\n    // DOM Event Listener (listen to the changes of view)\n    input.oninput = function () {\n      changeName[name] = this.value\n    }\n  })\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-legacy-reactivity",children:"Vue Legacy Reactivity"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://ustbhuangyi.github.io/vue-analysis/v2/reactive/summary.html",children:(0,i.jsx)(n.img,{alt:"Reactive",src:t(6420).A+"",width:"1898",height:"1278"})})}),"\n",(0,i.jsx)(n.p,{children:"Collect deps (get):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcher.get()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"pushTarget(watcher)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcherGetter()"}),": Access reactive object ",(0,i.jsx)(n.code,{children:"reactiveObject.key"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reactiveObject.get(key)"})," (",(0,i.jsx)(n.code,{children:"defineReactive"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dep.depend()"})," + ",(0,i.jsx)(n.code,{children:"childObserver.dep.depend()"})," + ",(0,i.jsx)(n.code,{children:"dependArray()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Dep.target.addDep(dep)"})," -> ",(0,i.jsx)(n.code,{children:"watcher.addDep(dep)"}),"."]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"dep.addSub(watcher)"})}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dep.subs.push(watcher)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"popTarget()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcher.cleanupDeps()"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Dispatch updates (set):"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Change reactive object ",(0,i.jsx)(n.code,{children:"reactiveObject.key = value"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reactiveObject.set(key, value)"})," (",(0,i.jsx)(n.code,{children:"defineReactive"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dep.notify()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dep.subs.forEach(watcher => watcher.update())"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcher.update()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"queueWatcher(watcher)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"nextTick(flushSchedulerQueue)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcher.run()"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"watcher.get()"}),": Get new value and recollect deps."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"vue-watcher-and-observer",children:"Vue Watcher and Observer"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/observer/watcher.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Watcher \u7684\u521b\u5efa\u987a\u5e8f\u4e3a\u5148\u7236\u540e\u5b50, \u6267\u884c\u987a\u5e8f (WatcherQueue) \u4fdd\u6301\u5148\u7236\u540e\u5b50."}),"\n",(0,i.jsx)(n.li,{children:"\u7528\u6237\u81ea\u5b9a\u4e49 Watcher \u8981\u4f18\u5148\u4e8e RenderWatcher \u6267\u884c (\u5148\u521b\u5efa\u5148\u6267\u884c)."}),"\n",(0,i.jsx)(n.li,{children:"\u82e5\u4e00\u4e2a\u7ec4\u4ef6\u5728\u7236\u7ec4\u4ef6\u7684 Watcher \u6267\u884c\u671f\u95f4\u88ab\u9500\u6bc1, \u5219\u5b83\u5bf9\u5e94\u7684 Watcher \u6267\u884c\u90fd\u53ef\u4ee5\u88ab\u8df3\u8fc7."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"RenderWatcher"})," (built-in Watcher)\n",(0,i.jsx)(n.code,{children:"updateComponent = () => vm._update(vm._render(), hydrating)"}),":\nWhen reactive props and data changed,\n",(0,i.jsx)(n.code,{children:"updateComponent"})," get invoked automatically."]}),"\n",(0,i.jsxs)(n.li,{children:["\u56db\u79cd ",(0,i.jsx)(n.code,{children:"Watcher"})," \u7c7b\u578b:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Computed Watcher"}),": ",(0,i.jsx)(n.code,{children:"Computed Props"})," Watcher."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Sync Watcher"}),". ",(0,i.jsx)(n.code,{children:"sync: true"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Deep Watcher"}),": ",(0,i.jsx)(n.code,{children:"deep: true"}),", \u68c0\u6d4b ",(0,i.jsx)(n.code,{children:"Object"})," \u5185\u90e8\u53d8\u5316."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"User Watcher"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"let uid = 0\n\n/**\n * A watcher parses an expression, collects dependencies,\n * and fires callback when the expression value changes.\n * This is used for both the $watch() api and directives.\n */\nexport default class Watcher {\n  vm: Component\n  expression: string\n  cb: Function\n  id: number\n  deep: boolean\n  user: boolean\n  computed: boolean\n  sync: boolean\n  dirty: boolean\n  active: boolean\n  dep: Dep\n  deps: Array<Dep>\n  newDeps: Array<Dep>\n  depIds: SimpleSet\n  newDepIds: SimpleSet\n  before: Function | null\n  getter: Function\n  value: any\n\n  constructor(\n    vm: Component,\n    expOrFn: string | Function,\n    cb: Function,\n    options?: object,\n    isRenderWatcher?: boolean\n  ) {\n    this.vm = vm\n\n    if (isRenderWatcher)\n      vm._watcher = this\n\n    vm._watchers.push(this)\n\n    // options\n    if (options) {\n      this.deep = !!options.deep\n      this.user = !!options.user\n      this.computed = !!options.computed\n      this.sync = !!options.sync\n      this.before = options.before\n    } else {\n      this.deep = this.user = this.computed = this.sync = false\n    }\n\n    this.cb = cb\n    this.id = ++uid // uid for batching\n    this.active = true\n    this.dirty = this.computed // for computed watchers\n    this.deps = []\n    this.newDeps = []\n    this.depIds = new Set()\n    this.newDepIds = new Set()\n    this.expression = expOrFn.toString()\n\n    // parse expression for getter\n    if (typeof expOrFn === 'function') {\n      this.getter = expOrFn\n    } else {\n      this.getter = parsePath(expOrFn)\n\n      if (!this.getter)\n        this.getter = function () {}\n    }\n\n    if (this.computed) {\n      this.value = undefined\n      this.dep = new Dep()\n    } else {\n      this.value = this.get()\n    }\n  }\n\n  /**\n   * Evaluate the getter, and re-collect dependencies.\n   */\n  get() {\n    pushTarget(this)\n    const vm = this.vm\n    const value = this.getter.call(vm, vm)\n\n    if (this.deep)\n      traverse(value)\n\n    popTarget()\n    this.cleanupDeps()\n    return value\n  }\n\n  /**\n   * Add a dependency to this directive.\n   */\n  addDep(dep: Dep) {\n    const id = dep.id\n\n    if (!this.newDepIds.has(id)) {\n      this.newDepIds.add(id)\n      this.newDeps.push(dep)\n\n      if (!this.depIds.has(id))\n        dep.addSub(this)\n    }\n  }\n\n  /**\n   * Subscriber interface.\n   * Will be called when a dependency changes.\n   */\n  update() {\n    if (this.lazy)\n      this.dirty = true\n    else if (this.sync)\n      this.run()\n    else queueWatcher(this)\n  }\n\n  /**\n   * Scheduler job interface.\n   * Will be called by the scheduler.\n   */\n  run() {\n    if (this.active) {\n      const value = this.get()\n\n      if (value !== this.value || isObject(value) || this.deep) {\n        // set new value\n        const oldValue = this.value\n        this.value = value\n\n        if (this.user) {\n          const info = `callback for watcher \"${this.expression}\"`\n          invokeWithErrorHandling(\n            this.cb,\n            this.vm,\n            [value, oldValue],\n            this.vm,\n            info\n          )\n        } else {\n          this.cb.call(this.vm, value, oldValue)\n        }\n      }\n    }\n  }\n\n  /**\n   * Depend on this watcher. Only for computed property watchers.\n   */\n  depend() {\n    if (this.dep && Dep.target)\n      this.dep.depend()\n  }\n\n  /**\n   * Evaluate and return the value of the watcher.\n   * This only gets called for computed property watchers.\n   */\n  evaluate() {\n    if (this.dirty) {\n      this.value = this.get()\n      this.dirty = false\n    }\n\n    return this.value\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/observer/dep.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"import type Watcher from './watcher'\nimport { remove } from '../util/index'\n\nlet uid = 0\n\n/**\n * A dep is an observable that can have multiple\n * directives subscribing to it.\n */\nexport default class Dep {\n  static target: ?Watcher\n  id: number\n  subs: Array<Watcher>\n\n  constructor() {\n    this.id = uid++\n    this.subs = []\n  }\n\n  addSub(sub: Watcher) {\n    this.subs.push(sub)\n  }\n\n  removeSub(sub: Watcher) {\n    remove(this.subs, sub)\n  }\n\n  depend() {\n    if (Dep.target)\n      Dep.target.addDep(this)\n  }\n\n  notify() {\n    // stabilize the subscriber list first\n    const subs = this.subs.slice()\n    for (let i = 0, l = subs.length; i < l; i++) subs[i].update()\n  }\n}\n\n// the current target watcher being evaluated.\n// this is globally unique because there could be only one\n// watcher being evaluated at any time.\nDep.target = null\nconst targetStack = []\n\nexport function pushTarget(_target: ?Watcher) {\n  if (Dep.target)\n    targetStack.push(Dep.target)\n  Dep.target = _target\n}\n\nexport function popTarget() {\n  Dep.target = targetStack.pop()\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/observer/index.js"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/**\n * Observer class that is attached to each observed\n * object. Once attached, the observer converts the target\n * object's property keys into getter/setters that\n * collect dependencies and dispatch updates.\n */\nexport class Observer {\n  value: any\n  dep: Dep\n  vmCount: number // number of vms that have this object as root $data\n\n  constructor(value: any) {\n    this.value = value\n    this.dep = new Dep()\n    this.vmCount = 0\n    def(value, '__ob__', this)\n\n    if (Array.isArray(value)) {\n      if (hasProto)\n        protoAugment(value, arrayMethods)\n      else copyAugment(value, arrayMethods, arrayKeys)\n\n      this.observeArray(value)\n    } else {\n      this.walk(value)\n    }\n  }\n\n  /**\n   * Walk through all properties and convert them into\n   * getter/setters. This method should only be called when\n   * value type is Object.\n   */\n  walk(obj: object) {\n    const keys = Object.keys(obj)\n\n    for (let i = 0; i < keys.length; i++) defineReactive(obj, keys[i])\n  }\n\n  /**\n   * Observe a list of Array items.\n   */\n  observeArray(items: Array<any>) {\n    for (let i = 0, l = items.length; i < l; i++) observe(items[i])\n  }\n}\n\n/**\n * Attempt to create an observer instance for a value,\n * returns the new observer if successfully observed,\n * or the existing observer if the value already has one.\n */\nexport function observe(value: any, asRootData: ?boolean): Observer | void {\n  if (!isObject(value) || value instanceof VNode)\n    return\n\n  let ob: Observer | void\n\n  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {\n    ob = value.__ob__\n  } else if (\n    shouldObserve\n    && !isServerRendering()\n    && (Array.isArray(value) || isPlainObject(value))\n    && Object.isExtensible(value)\n    && !value._isVue\n  ) {\n    ob = new Observer(value)\n  }\n\n  if (asRootData && ob)\n    ob.vmCount++\n\n  return ob\n}\n\n/**\n * Define a reactive property on an Object.\n */\nexport function defineReactive(\n  obj: object,\n  key: string,\n  val: any,\n  customSetter?: ?Function,\n  shallow?: boolean\n) {\n  const dep = new Dep()\n\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n\n  if (property && property.configurable === false)\n    return\n\n  // cater for pre-defined getter/setters\n  const getter = property && property.get\n  const setter = property && property.set\n\n  if ((!getter || setter) && arguments.length === 2)\n    val = obj[key]\n\n  let childOb = !shallow && observe(val)\n\n  Object.defineProperty(obj, key, {\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGetter() {\n      const value = getter ? getter.call(obj) : val\n\n      if (Dep.target) {\n        dep.depend()\n\n        // \u5bf9\u4e8e\u6570\u7ec4\u7684\u7279\u6b8a\u5904\u7406:\n        if (childOb) {\n          // 1. \u6536\u96c6\u6570\u7ec4\u672c\u8eab\u4f9d\u8d56.\n          childOb.dep.depend()\n\n          // 2. \u6536\u96c6\u5d4c\u5957\u6570\u7ec4\u4f9d\u8d56.\n          if (Array.isArray(value))\n            dependArray(value)\n        }\n      }\n\n      return value\n    },\n    set: function reactiveSetter(newVal) {\n      const value = getter ? getter.call(obj) : val\n\n      /* eslint-disable no-self-compare */\n      if (newVal === value || (newVal !== newVal && value !== value))\n        return\n\n      if (setter)\n        setter.call(obj, newVal)\n      else val = newVal\n\n      childOb = !shallow && observe(newVal)\n      dep.notify()\n    },\n  })\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-array-watcher",children:"Vue Array Watcher"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const methodsToPatch = [\n  'push',\n  'pop',\n  'shift',\n  'unshift',\n  'splice',\n  'sort',\n  'reverse',\n]\n\nmethodsToPatch.forEach((method) => {\n  // Cache original method.\n  const original = Array.prototype[method]\n\n  def(arrayMethods, method, function mutator(...args) {\n    const result = original.apply(this, args)\n    const ob = this.__ob__\n    let inserted\n\n    switch (method) {\n      case 'push':\n      case 'unshift':\n        inserted = args\n        break\n      case 'splice':\n        inserted = args.slice(2)\n        break\n    }\n\n    if (inserted)\n      ob.observeArray(inserted)\n    ob.dep.notify()\n    return result\n  })\n})\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-global-set-and-delete-api",children:"Vue Global Set and Delete API"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/**\n * Set a property on an object. Adds the new property and\n * triggers change notification if the property doesn't\n * already exist.\n */\nVue.set = function set(target: Array<any> | object, key: any, val: any): any {\n  if (Array.isArray(target) && isValidArrayIndex(key)) {\n    target.length = Math.max(target.length, key)\n    target.splice(key, 1, val)\n    return val\n  }\n\n  if (key in target && !(key in Object.prototype)) {\n    target[key] = val\n    return val\n  }\n\n  const ob = target.__ob__\n\n  if (target._isVue || (ob && ob.vmCount))\n    return val\n\n  if (!ob) {\n    target[key] = val\n    return val\n  }\n\n  defineReactive(ob.value, key, val)\n  ob.dep.notify()\n  return val\n}\n\n/**\n * Delete a property and trigger change if necessary.\n */\nVue.del = function del(target: Array<any> | object, key: any) {\n  if (Array.isArray(target) && isValidArrayIndex(key)) {\n    target.splice(key, 1)\n    return\n  }\n\n  const ob = target.__ob__\n\n  if (target._isVue || (ob && ob.vmCount))\n    return\n\n  if (!hasOwn(target, key))\n    return\n\n  delete target[key]\n\n  if (!ob)\n    return\n\n  ob.dep.notify()\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-computed-watcher",children:"Vue Computed Watcher"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"core/instance/state.js"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Computed Props"})," \u53ea\u5173\u6ce8\u6700\u7ec8\u8ba1\u7b97\u7ed3\u679c\u662f\u5426\u53d1\u751f\u53d8\u5316, \u662f\u4e00\u79cd\u6027\u80fd\u4f18\u5316\u624b\u6bb5."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Computed Props"})," \u6700\u7ec8\u8ba1\u7b97\u7ed3\u679c\u4e0d\u53d8, \u4e0d\u89e6\u53d1\u540e\u7eed\u66f4\u65b0."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Computed Props"})," \u521b\u5efa\u7684 ",(0,i.jsx)(n.code,{children:"Watcher"})," \u79f0\u4e3a ",(0,i.jsx)(n.code,{children:"Computed Watcher"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"const computedWatcherOptions = { computed: true }\n\nfunction initComputed(vm: Component, computed: object) {\n  const watchers = (vm._computedWatchers = Object.create(null))\n\n  for (const key in computed) {\n    const userDef = computed[key]\n    const getter = typeof userDef === 'function' ? userDef : userDef.get\n\n    // create internal watcher for the computed property.\n    watchers[key] = new Watcher(\n      vm,\n      getter || noop,\n      noop,\n      computedWatcherOptions\n    )\n\n    if (!(key in vm))\n      defineComputed(vm, key, userDef)\n  }\n}\n\nexport function defineComputed(\n  target: any,\n  key: string,\n  userDef: object | Function\n) {\n  if (typeof userDef === 'function') {\n    sharedPropertyDefinition.get = createComputedGetter(key)\n    sharedPropertyDefinition.set = noop\n  } else {\n    sharedPropertyDefinition.get = userDef.get ?? noop\n    sharedPropertyDefinition.set = userDef.set ?? noop\n  }\n\n  Object.defineProperty(target, key, sharedPropertyDefinition)\n}\n\nfunction createComputedGetter(key) {\n  return function computedGetter() {\n    const watcher = this._computedWatchers && this._computedWatchers[key]\n\n    if (watcher) {\n      watcher.depend()\n      return watcher.evaluate()\n    }\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Legacy ",(0,i.jsx)(n.code,{children:"Vuex"})," rely on ",(0,i.jsx)(n.code,{children:"Computed Props"}),",\nsee ",(0,i.jsxs)(n.a,{href:"https://github.com/vuejs/vuex/blob/3.x/src/store.js#L281",children:[(0,i.jsx)(n.code,{children:"Store"})," constructor"]}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function resetStoreVM(store, state, hot) {\n  const oldVm = store._vm\n  store.getters = {}\n  store._makeLocalGettersCache = Object.create(null)\n  const wrappedGetters = store._wrappedGetters\n  const computed = {}\n\n  forEachValue(wrappedGetters, (fn, key) => {\n    computed[key] = partial(fn, store)\n    Object.defineProperty(store.getters, key, {\n      get: () => store._vm[key],\n      enumerable: true,\n    })\n  })\n\n  // Use a `Vue` instance to store the state tree.\n  const silent = Vue.config.silent\n  Vue.config.silent = true\n  store._vm = new Vue({\n    data() {\n      return {\n        $$state: state,\n      }\n    },\n    computed,\n  })\n  Vue.config.silent = silent\n\n  if (store.strict)\n    enableStrictMode(store)\n\n  if (oldVm) {\n    if (hot) {\n      store._withCommit(() => {\n        oldVm._data.$$state = null\n      })\n    }\n\n    Vue.nextTick(() => oldVm.$destroy())\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vue-router-watcher",children:"Vue Router Watcher"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"<route-link>"})," clicked."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"vm.$router.push(location)"}),"/",(0,i.jsx)(n.code,{children:"vm.$router.replace(location)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"transitionTo(location, onComplete)"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Call routes guard hooks."}),"\n",(0,i.jsxs)(n.li,{children:["Change ",(0,i.jsx)(n.code,{children:"vm._routerRoot._route"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Call ",(0,i.jsx)(n.code,{children:"window.history.pushState"}),"/",(0,i.jsx)(n.code,{children:"window.history.replaceState"})," in ",(0,i.jsx)(n.code,{children:"onComplete"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"vm.$route"})," trigger ",(0,i.jsx)(n.code,{children:"<route-view>"})," re-rendering."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"vue-modern-reactivity",children:"Vue Modern Reactivity"}),"\n",(0,i.jsx)(n.h3,{id:"reactive-system",children:"Reactive System"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"effect.ts"}),": ",(0,i.jsx)(n.code,{children:"effect"}),", ",(0,i.jsx)(n.code,{children:"track"}),", ",(0,i.jsx)(n.code,{children:"trigger"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"baseHandlers.ts"}),": proxy handler (",(0,i.jsx)(n.code,{children:"get"})," and ",(0,i.jsx)(n.code,{children:"set"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"reactive.ts"}),": ",(0,i.jsx)(n.code,{children:"reactive"})," using ES6 Proxy."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ref.ts"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"reactive reference using Object Accessors."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ref"})," performant over ",(0,i.jsx)(n.code,{children:"reactive"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"computed.ts"}),": ",(0,i.jsx)(n.code,{children:"computed"})," using ",(0,i.jsx)(n.code,{children:"effect"})," and return a ",(0,i.jsx)(n.code,{children:"ref"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"reactive-effects",children:"Reactive Effects"}),"\n",(0,i.jsxs)(n.p,{children:["Data ",(0,i.jsx)(n.code,{children:"getter"}),"/",(0,i.jsx)(n.code,{children:"setter"})," -> Notify -> Watcher -> Trigger --\x3e Renderer:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"console.log(data.a) // getHook() get called.\ndata.a = 2 // setHook() get called.\n"})}),"\n",(0,i.jsx)(n.p,{children:"Effects bucket:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"targetMap"})," = ",(0,i.jsx)(n.code,{children:"target: effectsMap"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"effectsMap"})," = ",(0,i.jsx)(n.code,{children:"keyName: effectsSet"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"type Primitive = string | number | boolean\ntype Key = string | symbol\ntype Effect<T> = () => T\n\nconst runningEffects = []\n\nconst targetMap = new WeakMap()\n\nconst IterateKey = Symbol('IterateKey')\nconst LengthKey = 'length'\n\n// runEffect -> effect -> proxy.get -> track.\nfunction createEffect<T>(effect: Effect<T>) {\n  runningEffects.push(effect)\n  effect()\n  runningEffects.pop()\n}\n\nfunction track<T extends object>(target: T, key: Key) {\n  for (const effect of runningEffects) {\n    let effectsMap = targetMap.get(target)\n    if (!effectsMap)\n      targetMap.set(target, (effectsMap = new Map()))\n\n    let effects = effectsMap.get(key)\n    if (!effects)\n      effectsMap.set(key, (effects = new Set()))\n\n    effects.add(effect)\n  }\n}\n\nfunction trigger<T extends object>(target: T, key: Key, type: Type) {\n  const effectsMap = targetMap.get(target)\n  if (!effectsMap)\n    return\n\n  const effectsToRun = new Set()\n\n  const ordinaryEffects = effectsMap.get(key)\n  ordinaryEffects?.forEach((effect) => {\n    // Remove current running effect\n    // to avoid infinite call stack\n    // (skip triggering current tracking effect):\n    // reactive.foo = reactive.foo + 1;\n    if (effect !== runningEffects.top())\n      effectsToRun.add(effect)\n  })\n\n  if (type === 'ADD' || type === 'DELETE') {\n    const iterateEffects = effectsMap.get(IterateKey)\n    iterateEffects?.forEach((effect) => {\n      if (effect !== runningEffects.top())\n        effectsToRun.add(effect)\n    })\n  }\n\n  if (type === 'LENGTH') {\n    const lengthEffects = effectsMap.get(LengthKey)\n    lengthEffects?.forEach((effect) => {\n      if (effect !== runningEffects.top())\n        effectsToRun.add(effect)\n    })\n  }\n\n  effectsToRun.forEach((effect) => {\n    if (effect.options.scheduler)\n      effect.options.scheduler(effect)\n    else effect()\n  })\n}\n\nexport function reactive<T extends object>(target: T) {\n  const handler: ProxyHandler<T> = {\n    get(target, key, receiver) {\n      const value = Reflect.get(target, key, receiver)\n      track(target, key)\n      if (value !== null && typeof value === 'object')\n        return reactive(value)\n      else return value\n    },\n    has(target, key) {\n      track(target, key)\n      return Reflect.has(target, key)\n    },\n    ownKeys(target) {\n      // Proxy `for key in target` operator.\n      track(target, Array.isArray(target) ? LengthKey : IterateKey)\n      return Reflect.ownKeys(target)\n    },\n    set(target, key, value, receiver) {\n      const type = Array.isArray(target)\n        ? Number(key) < target.length\n          ? 'SET'\n          : 'LENGTH'\n        : Object.hasOwn(target, key)\n          ? 'SET'\n          : 'ADD'\n      const oldValue = Reflect.get(target, key, receiver)\n      const result = Reflect.set(target, key, value, receiver)\n      if (result && oldValue !== value)\n        trigger(target, key, type)\n      return result\n    },\n    deleteProperty(target, key) {\n      const isOwnKey = Object.hasOwn(target, key)\n      const result = Reflect.deleteProperty(target, key)\n      if (result && isOwnKey)\n        trigger(target, key, 'DELETE')\n      return result\n    },\n  }\n\n  return new Proxy(target, handler)\n}\n\nexport function ref<T extends Primitive>(raw?: T) {\n  const refObject = {\n    get value() {\n      track(refObject, 'value')\n      return raw\n    },\n    set value(newValue: T) {\n      raw = newValue\n      trigger(refObject, 'value')\n    },\n  }\n\n  return refObject\n}\n\nexport function computed<T extends Primitive>(getter: () => T) {\n  const refObject = ref<T>()\n  createEffect(() => (refObject.value = getter()))\n  return refObject\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"interface Product {\n  price: number\n  quantity: number\n}\n\nconst product = reactive<Product>({ price: 5, quantity: 2 })\nconst salePrice = computed(() => product.price * 0.9)\nconst total = computed(() => salePrice.value * product.quantity)\n\nconsole.assert(salePrice.value === 4.5)\nconsole.assert(total.value === 9)\n\nproduct.quantity = 3\nconsole.assert(total.value === 13.5)\n\nproduct.quantity = 4\nconsole.assert(total.value === 18)\n\nproduct.price = 6\nconsole.assert(salePrice.value === 5.4)\nconsole.assert(total.value === 21.6)\n\nproduct.price = 10\nconsole.assert(salePrice.value === 9)\nconsole.assert(total.value === 36)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"reactive-proxy",children:"Reactive Proxy"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Simple: ",(0,i.jsx)(n.code,{children:"Proxy"})," \u4f7f\u7528\u4e0a\u6bd4 ",(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u65b9\u4fbf.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u53ea\u80fd\u76d1\u542c\u5bf9\u8c61, \u5bfc\u81f4 ",(0,i.jsx)(n.code,{children:"Vue 2"})," ",(0,i.jsx)(n.code,{children:"data"})," \u5c5e\u6027\u5fc5\u987b\u901a\u8fc7\u4e00\u4e2a\u8fd4\u56de\u5bf9\u8c61\u7684\u51fd\u6570\u65b9\u5f0f\u521d\u59cb\u5316,"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Vue 3"})," \u66f4\u52a0\u591a\u5143\u5316, \u53ef\u4ee5\u76d1\u542c\u4efb\u610f\u6570\u636e."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Performant: ",(0,i.jsx)(n.code,{children:"Proxy"})," \u4ee3\u7406\u6574\u4e2a\u5bf9\u8c61, ",(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u53ea\u4ee3\u7406\u5bf9\u8c61\u4e0a\u7684\u67d0\u4e2a\u5c5e\u6027.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u7531\u4e8e\u6bcf\u6b21\u53ea\u80fd\u76d1\u542c\u5bf9\u8c61\u4e00\u4e2a\u952e\u7684 ",(0,i.jsx)(n.code,{children:"get"}),"/",(0,i.jsx)(n.code,{children:"set"}),", \u5bfc\u81f4\u9700\u8981\u5faa\u73af\u76d1\u542c\u6d6a\u8d39\u6027\u80fd."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u4e00\u6b21\u6027\u76d1\u542c\u5230\u6240\u6709\u5c5e\u6027."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Lazy: ",(0,i.jsx)(n.code,{children:"Proxy"})," \u6027\u80fd\u4f18\u4e8e ",(0,i.jsx)(n.code,{children:"Object.defineProperty"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5982\u679c\u5bf9\u8c61\u5185\u90e8\u8981\u5168\u90e8\u9012\u5f52\u4ee3\u7406, \u5219 ",(0,i.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u53ea\u5728\u8c03\u7528\u65f6\u9012\u5f52."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u9700\u8981\u5728\u4e00\u5f00\u59cb\u5c31\u5168\u90e8\u9012\u5f52."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Feature:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u8c61\u4e0a\u5b9a\u4e49\u65b0\u5c5e\u6027\u65f6, \u53ea\u6709 ",(0,i.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u76d1\u542c\u5230:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Vue2: \u63d0\u4f9b ",(0,i.jsx)(n.code,{children:"Vue.set"}),"/",(0,i.jsx)(n.code,{children:"Vue.delete"})," \u7b49\u8f85\u52a9\u65b9\u6cd5."]}),"\n",(0,i.jsxs)(n.li,{children:["Vue3: ",(0,i.jsx)(n.code,{children:"Proxy"})," \u76d1\u542c\u65b0\u5c5e\u6027."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u6570\u7ec4\u65b0\u589e\u5220\u9664\u4fee\u6539\u65f6, \u53ea\u6709 ",(0,i.jsx)(n.code,{children:"Proxy"})," \u53ef\u4ee5\u76d1\u542c\u5230:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u65e0\u6cd5\u76d1\u542c\u6570\u7ec4, ",(0,i.jsx)(n.code,{children:"Proxy"})," \u5219\u53ef\u4ee5\u76f4\u63a5\u76d1\u542c\u6570\u7ec4\u53d8\u5316."]}),"\n",(0,i.jsx)(n.li,{children:"Vue2: \u91cd\u5199\u6570\u7ec4\u65b9\u6cd5\u76d1\u542c\u6570\u7ec4\u53d8\u5316."}),"\n",(0,i.jsxs)(n.li,{children:["Vue3: ",(0,i.jsx)(n.code,{children:"Proxy"})," \u76d1\u542c\u6570\u7ec4\u53d8\u5316."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"Proxy"})," \u4e0d\u517c\u5bb9 IE, ",(0,i.jsx)(n.code,{children:"Object.defineProperty"})," \u4e0d\u517c\u5bb9 IE8 \u53ca\u4ee5\u4e0b."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Vue 2:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"Vue.set(app.items, indexOfItem, newValue)\nVue.set(app.product, newField, newValue)\n"})}),"\n",(0,i.jsx)(n.p,{children:"Vue 3:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"app.items[indexOfItem] = newValue\napp.product[newField] = newValue\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-setup",children:"Vue Setup"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"https://github.com/vuejs/core/blob/main/packages/runtime-core/src/component.ts",children:"Setup workflow"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/vuejs/core/blob/main/packages/runtime-core/src/renderer.ts",children:(0,i.jsx)(n.code,{children:"mountComponent(initialVNode, container)"})}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"instance = createComponentInstance(initialVNode)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/vuejs/core/blob/main/packages/runtime-core/src/component.ts",children:(0,i.jsx)(n.code,{children:"setupComponent(instance)"})}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setupStatefulComponent(instance)"}),".","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setupContext = createSetupContext(instance)"}),": ",(0,i.jsx)(n.code,{children:"{ attrs, slots, emit }"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setupResult = setup(instance.props, setupContext)"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"handleSetupResult(instance, setupResult)"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5bf9\u6e32\u67d3\u4e0a\u4e0b\u6587 ",(0,i.jsx)(n.code,{children:"instance.ctx"})," (",(0,i.jsx)(n.code,{children:"Options API"})," \u7528\u6237\u4ee3\u7801\u4e2d\u7684 ",(0,i.jsx)(n.code,{children:"this"}),") \u5c5e\u6027\u7684\u8bbf\u95ee\u548c\u4fee\u6539,\n\u4ee3\u7406\u5230\u5bf9 ",(0,i.jsx)(n.code,{children:"setupState"}),"/",(0,i.jsx)(n.code,{children:"ctx"}),"/",(0,i.jsx)(n.code,{children:"data"}),"/",(0,i.jsx)(n.code,{children:"props"})," \u4e2d\u7684\u6570\u636e\u7684\u8bbf\u95ee\u548c\u4fee\u6539\n(",(0,i.jsx)(n.code,{children:"PublicInstanceProxyHandlers"}),"):","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"setupState"}),": ",(0,i.jsx)(n.code,{children:"setup()"})," return value, \u6700\u9ad8\u4f18\u5148\u7ea7."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"data"}),": data from ",(0,i.jsx)(n.code,{children:"Options API"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"props"}),": props from ",(0,i.jsx)(n.code,{children:"Options API"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ctx"}),": computed value/methods from ",(0,i.jsx)(n.code,{children:"Options API"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function mountComponent(\n  initialVNode,\n  container,\n  anchor,\n  parentComponent,\n  parentSuspense,\n  isSVG,\n  optimized\n) {\n  // \u521b\u5efa\u7ec4\u4ef6\u5b9e\u4f8b\n  const instance = (initialVNode.component = createComponentInstance(\n    initialVNode,\n    parentComponent,\n    parentSuspense\n  ))\n\n  // \u8bbe\u7f6e\u7ec4\u4ef6\u5b9e\u4f8b\n  setupComponent(instance)\n\n  // \u8bbe\u7f6e\u5e76\u8fd0\u884c\u5e26\u526f\u4f5c\u7528\u7684\u6e32\u67d3\u51fd\u6570\n  setupRenderEffect(\n    instance,\n    initialVNode,\n    container,\n    anchor,\n    parentSuspense,\n    isSVG,\n    optimized\n  )\n}\n\nfunction createComponentInstance(vnode, parent, suspense) {\n  // \u7ee7\u627f\u7236\u7ec4\u4ef6\u5b9e\u4f8b\u4e0a\u7684 appContext, \u5982\u679c\u662f\u6839\u7ec4\u4ef6, \u5219\u76f4\u63a5\u4ece\u6839 vnode \u4e2d\u53d6.\n  const appContext\n    = (parent ? parent.appContext : vnode.appContext) || emptyAppContext\n\n  const instance = {\n    // \u7ec4\u4ef6\u552f\u4e00 id\n    uid: uid++,\n    // \u7ec4\u4ef6 vnode\n    vnode,\n    // \u7236\u7ec4\u4ef6\u5b9e\u4f8b\n    parent,\n    // app \u4e0a\u4e0b\u6587\n    appContext,\n    // vnode \u8282\u70b9\u7c7b\u578b\n    type: vnode.type,\n    // \u6839\u7ec4\u4ef6\u5b9e\u4f8b\n    root: null,\n    // \u65b0\u7684\u7ec4\u4ef6 vnode\n    next: null,\n    // \u5b50\u8282\u70b9 vnode\n    subTree: null,\n    // \u5e26\u526f\u4f5c\u7528\u66f4\u65b0\u51fd\u6570\n    update: null,\n    // \u6e32\u67d3\u51fd\u6570\n    render: null,\n    // \u6e32\u67d3\u4e0a\u4e0b\u6587\u4ee3\u7406\n    proxy: null,\n    // \u5e26\u6709 with \u533a\u5757\u7684\u6e32\u67d3\u4e0a\u4e0b\u6587\u4ee3\u7406\n    withProxy: null,\n    // \u54cd\u5e94\u5f0f\u76f8\u5173\u5bf9\u8c61\n    effects: null,\n    // \u4f9d\u8d56\u6ce8\u5165\u76f8\u5173\n    provides: parent ? parent.provides : Object.create(appContext.provides),\n    // \u6e32\u67d3\u4ee3\u7406\u7684\u5c5e\u6027\u8bbf\u95ee\u7f13\u5b58\n    accessCache: null,\n    // \u6e32\u67d3\u7f13\u5b58\n    renderCache: [],\n    // \u6e32\u67d3\u4e0a\u4e0b\u6587\n    ctx: EMPTY_OBJ,\n    // data \u6570\u636e\n    data: EMPTY_OBJ,\n    // props \u6570\u636e\n    props: EMPTY_OBJ,\n    // \u666e\u901a\u5c5e\u6027\n    attrs: EMPTY_OBJ,\n    // \u63d2\u69fd\u76f8\u5173\n    slots: EMPTY_OBJ,\n    // \u7ec4\u4ef6\u6216\u8005 DOM \u7684 ref \u5f15\u7528\n    refs: EMPTY_OBJ,\n    // setup \u51fd\u6570\u8fd4\u56de\u7684\u54cd\u5e94\u5f0f\u7ed3\u679c\n    setupState: EMPTY_OBJ,\n    // setup \u51fd\u6570\u4e0a\u4e0b\u6587\u6570\u636e\n    setupContext: null,\n    // \u6ce8\u518c\u7684\u7ec4\u4ef6\n    components: Object.create(appContext.components),\n    // \u6ce8\u518c\u7684\u6307\u4ee4\n    directives: Object.create(appContext.directives),\n    // suspense \u76f8\u5173\n    suspense,\n    // suspense \u5f02\u6b65\u4f9d\u8d56\n    asyncDep: null,\n    // suspense \u5f02\u6b65\u4f9d\u8d56\u662f\u5426\u90fd\u5df2\u5904\u7406\n    asyncResolved: false,\n    // \u662f\u5426\u6302\u8f7d\n    isMounted: false,\n    // \u662f\u5426\u5378\u8f7d\n    isUnmounted: false,\n    // \u662f\u5426\u6fc0\u6d3b\n    isDeactivated: false,\n    // \u751f\u547d\u5468\u671f, before create\n    bc: null,\n    // \u751f\u547d\u5468\u671f, created\n    c: null,\n    // \u751f\u547d\u5468\u671f, before mount\n    bm: null,\n    // \u751f\u547d\u5468\u671f, mounted\n    m: null,\n    // \u751f\u547d\u5468\u671f, before update\n    bu: null,\n    // \u751f\u547d\u5468\u671f, updated\n    u: null,\n    // \u751f\u547d\u5468\u671f, unmounted\n    um: null,\n    // \u751f\u547d\u5468\u671f, before unmount\n    bum: null,\n    // \u751f\u547d\u5468\u671f, deactivated\n    da: null,\n    // \u751f\u547d\u5468\u671f activated\n    a: null,\n    // \u751f\u547d\u5468\u671f render triggered\n    rtg: null,\n    // \u751f\u547d\u5468\u671f render tracked\n    rtc: null,\n    // \u751f\u547d\u5468\u671f error captured\n    ec: null,\n    // \u6d3e\u53d1\u4e8b\u4ef6\u65b9\u6cd5\n    emit: null,\n  }\n\n  // \u521d\u59cb\u5316\u6e32\u67d3\u4e0a\u4e0b\u6587\n  instance.ctx = new Proxy(instance, {\n    get(target, key, receiver) {\n      // data, props, computed, methods etc.\n      const [data, props] = target\n\n      if (data && key in data)\n        return data[key]\n      else if (key in props)\n        return props[key]\n      else console.error('Not exist.')\n    },\n    set(target, key, value, receiver) {\n      // data, props, computed, methods etc.\n      if (data && key in data)\n        data[key] = value\n      else if (key in props)\n        console.warn(`Attempting to mutate read-only prop ${key}.`)\n      else console.error('Not exist.')\n    },\n  })\n\n  // \u521d\u59cb\u5316\u6839\u7ec4\u4ef6\u6307\u9488\n  instance.root = parent ? parent.root : instance\n  // \u521d\u59cb\u5316\u6d3e\u53d1\u4e8b\u4ef6\u65b9\u6cd5\n  instance.emit = emit.bind(null, instance)\n\n  return instance\n}\n\nfunction setupComponent(instance, isSSR = false) {\n  const { props, children, shapeFlag } = instance.vnode\n\n  // STATEFUL_COMPONENT\n  const isStateful = shapeFlag & 4\n\n  // \u521d\u59cb\u5316 props\n  initProps(instance, props, isStateful, isSSR)\n  // \u521d\u59cb\u5316 \u63d2\u69fd\n  initSlots(instance, children)\n\n  // \u8bbe\u7f6e\u6709\u72b6\u6001\u7684\u7ec4\u4ef6\u5b9e\u4f8b\n  const setupResult = isStateful\n    ? setupStatefulComponent(instance, isSSR)\n    : undefined\n\n  return setupResult\n}\n\nfunction setupStatefulComponent(instance, isSSR) {\n  const Component = instance.type\n\n  // \u521b\u5efa\u6e32\u67d3\u4ee3\u7406\u7684\u5c5e\u6027\u8bbf\u95ee\u7f13\u5b58\n  instance.accessCache = {}\n\n  // \u521b\u5efa\u6e32\u67d3\u4e0a\u4e0b\u6587\u4ee3\u7406\n  instance.proxy = new Proxy(instance.ctx, PublicInstanceProxyHandlers)\n\n  // \u5224\u65ad\u5904\u7406 setup \u51fd\u6570\n  const { setup } = Component\n\n  if (setup) {\n    // \u5982\u679c setup \u51fd\u6570\u5e26\u53c2\u6570, \u5219\u521b\u5efa\u4e00\u4e2a setupContext\n    const setupContext = (instance.setupContext\n      = setup.length > 1 ? createSetupContext(instance) : null)\n    // \u6267\u884c setup \u51fd\u6570, \u83b7\u53d6\u7ed3\u679c\n    const setupResult = callWithErrorHandling(\n      setup,\n      instance,\n      0 /* SETUP_FUNCTION */,\n      [shallowReadonly(instance.props), setupContext]\n    )\n    // \u5904\u7406 setup \u6267\u884c\u7ed3\u679c\n    handleSetupResult(instance, setupResult)\n  } else {\n    // \u5b8c\u6210\u7ec4\u4ef6\u5b9e\u4f8b\u8bbe\u7f6e\n    finishComponentSetup(instance)\n  }\n}\n\nfunction handleSetupResult(instance, setupResult) {\n  if (isFunction(setupResult)) {\n    // setup \u8fd4\u56de\u6e32\u67d3\u51fd\u6570\n    instance.render = setupResult\n  } else if (isObject(setupResult)) {\n    // \u628a setup \u8fd4\u56de\u7ed3\u679c\u53d8\u6210\u54cd\u5e94\u5f0f\n    instance.setupState = reactive(setupResult)\n  }\n\n  finishComponentSetup(instance)\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"vue-reference",children:"Vue Reference"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/HcySunYang/code-for-vue-3-book",children:"Vue.js Design and Implementation"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},9228:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/Lifecycle-4a919f7471e246973e7380cf0871a739.png"},6420:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/Proxy-165836ddcbf17e6e058a1620bdd7ac73.png"},842:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(8101);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);